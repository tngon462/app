<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>T-NGON Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#da251d" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="T-NGON Admin" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <!-- Icons / Manifest -->
  <link rel="icon" sizes="192x192" href="./icons/icon-192.png" />
  <link rel="apple-touch-icon" href="./icons/icon-192.png" />
  <link rel="manifest" href="./admin.webmanifest" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <style>
    html, body { height: 100%; background:#f6f7f9; }
    .nav-link { display:block; padding:.5rem .75rem; border-radius:.5rem; font-weight:600; color:#374151; }
    .nav-link:hover { background:#f3f4f6; }
    .nav-link.active { background:rgba(218,37,29,.12); color:#da251d; }
    .toggle input { display:none; }
    .toggle label {
      width:56px; height:32px; border-radius:999px; display:inline-block; position:relative;
      background:#e5e7eb; transition:.2s;
    }
    .toggle label::after{
      content:""; position:absolute; top:4px; left:4px; width:24px; height:24px; border-radius:999px;
      background:#fff; box-shadow:0 1px 3px rgba(0,0,0,.25); transition:.2s;
    }
    .toggle input:checked + label { background:#10b981; }
    .toggle input:checked + label::after { transform:translateX(24px); }
    #ads-iframe { width:100%; height:calc(100vh - 64px); border:0; background:#fff; }
    .app-badge { font-size:12px; padding:2px 6px; border-radius:6px; border:1px solid #e5e7eb; color:#6b7280; }

    /* Off-canvas sidebar (mobile) */
    .drawer { position:fixed; top:64px; left:0; height:calc(100vh - 64px); width:260px; background:#fff;
      border-right:1px solid #e5e7eb; transform:translateX(-100%); transition:transform .2s ease; z-index:40; }
    .drawer.open { transform:translateX(0); }
    .drawer-mask { position:fixed; inset:0; background:rgba(0,0,0,.25); display:none; z-index:30; }
    .drawer-mask.show { display:block; }

    /* On md+ keep static sidebar */
    @media (min-width:768px){
      .drawer { position:static; transform:none; height:auto; width:260px; z-index:auto; }
      .drawer-mask { display:none !important; }
      .layout { display:flex; }
      .content { min-height:calc(100vh - 64px); }
    }
  </style>
</head>
<body class="bg-gray-50">
  <!-- Topbar -->
  <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-3 md:px-6">
    <div class="flex items-center gap-3">
      <button id="btnMenu" class="md:hidden p-2 -ml-1 rounded hover:bg-gray-100" aria-label="Mở menu">☰</button>
      <img src="./icons/icon-72.png" alt="logo" class="w-8 h-8 rounded-md" />
      <button id="homeBtn" class="text-xl font-extrabold tracking-wide text-[#da251d]">T-NGON Admin</button>
      <span id="pwaBadge" class="app-badge hidden">Installed</span>
    </div>
    <div class="flex items-center gap-2">
      <button id="btnInstall" class="px-3 py-1.5 rounded-md bg-[#da251d] text-white text-sm hidden">Cài đặt ứng dụng</button>
      <div id="connBadge" class="text-xs text-gray-500">Đang kiểm tra kết nối…</div>
    </div>
  </header>

  <!-- Drawer mask (mobile) -->
  <div id="drawerMask" class="drawer-mask"></div>

  <div class="layout">
    <!-- Sidebar / Drawer -->
    <aside id="drawer" class="drawer">
      <nav class="p-3 space-y-1">
        <a href="#screen" id="navScreen" class="nav-link">Tắt/Bật màn hình</a>
        <a href="#ads" id="navAds" class="nav-link">Up ảnh quảng cáo</a>
      </nav>
      <div class="p-3 text-xs text-gray-400 border-t">
        Phiên bản <span id="ver">—</span>
      </div>
    </aside>

    <!-- Main content -->
    <main class="content flex-1">
      <!-- View: Screen control -->
      <section id="viewScreen" class="p-4 md:p-6 hidden">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Điều khiển màn hình tablet</h2>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 md:p-5 max-w-3xl">
          <div class="flex items-center justify-between gap-3">
            <div class="min-w-0">
              <div class="text-lg font-semibold truncate">Bật màn hình (toàn quán)</div>
              <div id="screenStatusText" class="text-sm text-gray-500 mt-0.5">Đang tải trạng thái…</div>
            </div>
            <div class="toggle shrink-0">
              <input type="checkbox" id="screenToggle" />
              <label for="screenToggle" aria-label="Bật/Tắt"></label>
            </div>
          </div>

          <div class="mt-5 grid grid-cols-2 sm:grid-cols-3 gap-3">
            <button id="btnOn"  class="px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">Bật tất cả</button>
            <button id="btnOff" class="px-4 py-2 rounded-lg bg-gray-800 text-white hover:bg-black">Tắt (màn đen)</button>
          </div>

          <!-- Điều khiển từng tablet -->
          <div class="mt-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-3">Điều khiển từng tablet</h3>
            <div id="tablesGrid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3"></div>
            <p class="text-xs text-gray-400 mt-2">
              Gợi ý: Nhấn “Bật tất cả” để xoá trạng thái tắt lẻ, sau đó tắt riêng những bàn cần.
            </p>
          </div>

          <div id="errorBox" class="mt-4 hidden p-3 rounded-lg bg-red-50 text-red-700 text-sm"></div>
        </div>
      </section>

      <!-- View: Ads (iframe) -->
      <section id="viewAds" class="hidden">
        <iframe id="ads-iframe" src="about:blank" referrerpolicy="no-referrer"></iframe>
      </section>
    </main>
  </div>

  <script>
    // ===== App version =====
    const APP_VERSION = "1.3.3";
    document.getElementById('ver').textContent = APP_VERSION;

    // ===== Firebase config =====
    const firebaseConfig = {
      apiKey: "AIzaSyB4u2G41xdGkgBC0KltleRpcg5Lwru2RIU",
      authDomain: "tngon-b37d6.firebaseapp.com",
      databaseURL: "https://tngon-b37d6-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "tngon-b37d6",
      storageBucket: "tngon-b37d6.firebasestorage.app",
      messagingSenderId: "580319242104",
      appId: "1:580319242104:web:6922e4327bdc8286c30a8d",
      measurementId: "G-LHEH8ZC6SL"
    };

    // ===== UI refs =====
    const views = { screen: document.getElementById('viewScreen'), ads: document.getElementById('viewAds') };
    const navScreen = document.getElementById('navScreen');
    const navAds = document.getElementById('navAds');
    const homeBtn = document.getElementById('homeBtn');
    const connBadge = document.getElementById('connBadge');
    const pwaBadge = document.getElementById('pwaBadge');
    const btnInstall = document.getElementById('btnInstall');

    const toggleEl = document.getElementById('screenToggle');
    const statusEl = document.getElementById('screenStatusText');
    const btnOn = document.getElementById('btnOn');
    const btnOff = document.getElementById('btnOff');
    const errorBox = document.getElementById('errorBox');

    // Drawer (mobile)
    const drawer = document.getElementById('drawer');
    const drawerMask = document.getElementById('drawerMask');
    const btnMenu = document.getElementById('btnMenu');
    function openDrawer(){ drawer.classList.add('open'); drawerMask.classList.add('show'); }
    function closeDrawer(){ drawer.classList.remove('open'); drawerMask.classList.remove('show'); }
    btnMenu.addEventListener('click', openDrawer);
    drawerMask.addEventListener('click', closeDrawer);
    [navScreen, navAds].forEach(a => a.addEventListener('click', () => { if (window.innerWidth < 768) closeDrawer(); }));

    function showError(msg) { errorBox.textContent = msg||''; errorBox.classList.toggle('hidden', !msg); }

    function setActive(hash) {
      [navScreen, navAds].forEach(a => a.classList.remove('active'));
      if (hash === '#ads') navAds.classList.add('active'); else navScreen.classList.add('active');
      Object.values(views).forEach(v => v.classList.add('hidden'));
      if (hash === '#ads') {
        views.ads.classList.remove('hidden');
        const ifr = document.getElementById('ads-iframe');
        if (!ifr.src || ifr.src === 'about:blank') ifr.src = 'https://pic-flame.vercel.app/';
      } else {
        views.screen.classList.remove('hidden');
      }
    }
    function route() { setActive(location.hash || '#screen'); }
    window.addEventListener('hashchange', route);
    homeBtn.addEventListener('click', () => { location.href = location.pathname; });

    // ===== PWA (Service Worker + Install Prompt) =====
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw-admin.js')
        .then(reg => {
          reg.addEventListener('updatefound', () => {
            const installing = reg.installing;
            installing?.addEventListener('statechange', () => {
              if (installing.state === 'installed' && navigator.serviceWorker.controller) {
                const bar = document.createElement('div');
                bar.className = 'fixed bottom-4 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-4 py-2 rounded-lg shadow';
                bar.textContent = 'Có bản cập nhật. Đang tự tải…';
                document.body.appendChild(bar);
                setTimeout(()=> bar.remove(), 3000);
              }
            });
          });
        })
        .catch(console.error);
    }

    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      btnInstall.classList.remove('hidden');
    });
    btnInstall.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      if (outcome === 'accepted') btnInstall.classList.add('hidden');
      deferredPrompt = null;
    });
    window.addEventListener('appinstalled', () => {
      pwaBadge.classList.remove('hidden');
      btnInstall.classList.add('hidden');
    });

    // ===== Firebase init + anonymous auth + wiring =====
    (async function init() {
      try {
        firebase.initializeApp(firebaseConfig);

        const db = firebase.database();
        const refConnected = db.ref(".info/connected");
        refConnected.on('value', (snap) => {
          const online = !!snap.val();
          connBadge.textContent = online ? 'Đã kết nối Firebase' : 'Mất kết nối Firebase';
          connBadge.className = online ? 'text-xs text-emerald-600' : 'text-xs text-red-600';
        });

        // Ẩn danh
        await firebase.auth().signInAnonymously().catch(e => {
          console.error('Anonymous sign-in failed:', e);
          showError('Không đăng nhập ẩn danh được: ' + (e?.message||e));
        });
        await new Promise(r => { const un = firebase.auth().onAuthStateChanged(()=>{ un(); r(); }); });

        // ===== Global control =====
        const refScreen = db.ref('control/screen'); // "on" | "off"

        // Nếu chưa có giá trị -> tự khởi tạo "on"
        refScreen.once('value').then(snap => { if (!snap.exists()) refScreen.set('on'); });

        // Subscribe trạng thái toàn quán
        refScreen.on('value', (snap) => {
          showError('');
          const v = snap.exists() ? snap.val() : 'on';
          const isOn = String(v).toLowerCase() === 'on';
          toggleEl.checked = isOn;
          statusEl.textContent = isOn ? 'Đang bật màn hình' : 'Đang tắt (phủ đen)';
        }, (err) => showError('Lỗi subscribe: ' + (err?.message||err)));

        async function setScreen(val) {
          showError('');
          const prev = toggleEl.checked;
          try { toggleEl.checked = (val === 'on'); await refScreen.set(val); }
          catch (e) { toggleEl.checked = prev; showError('Ghi thất bại: ' + (e?.message||e)); }
        }
        toggleEl.addEventListener('change', () => setScreen(toggleEl.checked ? 'on' : 'off'));

        // ===== Per-table controls =====
        const TABLE_COUNT = 15;
        const tablesGrid = document.getElementById('tablesGrid');
        const tableRefs = {};
        const tableStates = {};

        // Card mỗi bàn: công tắc + nút "Làm mới" NẰM DƯỚI công tắc
        function makeTableTile(i, onToggle, onRefresh) {
          const card = document.createElement('div');
          card.className = 'bg-white rounded-xl shadow-sm border border-gray-200 p-3 flex flex-col';

          const head = document.createElement('div');
          head.className = 'flex items-start justify-between gap-3';

          const left = document.createElement('div');
          left.className = 'min-w-0';
          left.innerHTML = `<div class="font-semibold text-gray-800">Bàn ${i}</div>
                            <div id="tb-status-${i}" class="text-xs text-gray-500">Đang tải…</div>`;

          const wrapper = document.createElement('div');
          wrapper.className = 'toggle';
          const input = document.createElement('input');
          input.type = 'checkbox';
          input.id = `tb-toggle-${i}`;
          const label = document.createElement('label');
          label.setAttribute('for', input.id);
          wrapper.appendChild(input);
          wrapper.appendChild(label);
          input.addEventListener('change', () => onToggle(i, input.checked ? 'on' : 'off'));

          head.appendChild(left);
          head.appendChild(wrapper);

          const btnRefresh = document.createElement('button');
          btnRefresh.textContent = 'Làm mới';
          btnRefresh.className = 'mt-2 self-end px-3 py-1.5 text-xs rounded-md bg-blue-600 text-white hover:bg-blue-700';
          btnRefresh.addEventListener('click', () => onRefresh(i));

          card.appendChild(head);
          card.appendChild(btnRefresh);
          return { card, input };
        }

        function renderPerTableControls() {
          tablesGrid.innerHTML = '';
          for (let i = 1; i <= TABLE_COUNT; i++) {
            const { card, input } = makeTableTile(i, setTableScreen, refreshTable);
            tablesGrid.appendChild(card);

            const statusElTb = document.getElementById(`tb-status-${i}`);
            const ref = db.ref(`control/tables/${i}/screen`);
            tableRefs[i] = ref;

            ref.on('value', async (snap) => {
              if (!snap.exists()) {
                try { await ref.set('on'); } catch(_) {}
                statusElTb.textContent = 'Đang bật (khởi tạo)';
                input.checked = true;
                tableStates[i] = 'on';
                return;
              }
              const val = (snap.val() || 'on').toString().toLowerCase();
              tableStates[i] = val;
              statusElTb.textContent = (val === 'on') ? 'Đang bật' : 'Đang tắt';
              if (input.checked !== (val === 'on')) input.checked = (val === 'on');
            }, (err) => {
              statusElTb.textContent = 'Lỗi: ' + (err?.message || err);
            });
          }
        }

        async function setTableScreen(i, val) {
          try {
            await tableRefs[i].set(val); // 'on' | 'off'
          } catch (e) {
            showError(`Ghi thất bại cho Bàn ${i}: ` + (e?.message || e));
            const input = document.getElementById(`tb-toggle-${i}`);
            if (input) input.checked = (tableStates[i] === 'on');
          }
        }

        // Làm mới 1 bàn → ghi vào signals/<ban>
        async function refreshTable(i) {
          showError('');
          try {
            const refSig = db.ref(`signals/${i}`);
            await refSig.set({
              status: 'expired',
              ts: firebase.database.ServerValue.TIMESTAMP
            });
          } catch (e) {
            showError(`Làm mới Bàn ${i} thất bại: ` + (e?.message || e));
          }
        }

        // Nút Bật/Tắt tất cả
        btnOn.addEventListener('click', async () => {
          try {
            await refScreen.set('on');
            const updates = {};
            for (let i=1;i<=TABLE_COUNT;i++) updates[`control/tables/${i}/screen`] = 'on';
            await db.ref().update(updates);
          } catch (e) {
            showError('Bật tất cả thất bại: ' + (e?.message||e));
          }
        });

        btnOff.addEventListener('click', async () => {
          try { await refScreen.set('off'); }
          catch (e) { showError('Tắt tất cả thất bại: ' + (e?.message||e)); }
        });

        renderPerTableControls();
        route();
      } catch (e) {
        console.error(e);
        showError('Lỗi khởi chạy: ' + (e?.message||e));
      }
    })();
  </script>
  // assets/js/device-bind.js vFINAL
(function(){
  'use strict';
  const LS = localStorage;
  const $ = (id)=>document.getElementById(id);
  const gotoSelect = window.gotoSelect || (()=>{});
  const gotoStart  = window.gotoStart  || (()=>{});
  const gotoPos    = window.gotoPos    || (()=>{});

  function uuid(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);return v.toString(16);});}
  let deviceId = LS.getItem('deviceId') || uuid(); LS.setItem('deviceId',deviceId);

  const db = firebase.database();

  // ===== GATE =====
  function showGate(msg){
    if($('code-gate')){ const e=$('code-error'); if(e&&msg)e.textContent=msg; return; }
    const w=document.createElement('div');
    w.id='code-gate';
    w.style='position:fixed;inset:0;z-index:9999;background:#fff;';
    w.innerHTML=`
    <div class="w-full h-full flex items-center justify-center p-6">
      <div class="max-w-sm w-full bg-white border rounded-2xl shadow p-6">
        <h1 class="text-2xl font-bold mb-4 text-center">Nhập mã iPad</h1>
        <input id="code-input" class="w-full border rounded px-4 py-3 text-center font-mono text-lg" placeholder="VD: A1B2C3" />
        <div id="code-error" class="text-center text-red-600 text-sm mt-2 h-5"></div>
        <button id="code-submit" class="mt-4 w-full py-3 bg-blue-600 text-white rounded-xl font-bold">XÁC NHẬN</button>
      </div>
    </div>`;
    document.body.appendChild(w);
    const input=$('code-input'),btn=$('code-submit'),err=$('code-error');
    btn.onclick=async ()=>{
      const code=(input.value||'').trim().toUpperCase();
      if(!code){ err.textContent='Nhập mã'; return; }
      try{ await claim(code); w.remove(); enterApp(); }
      catch(e){ err.textContent=e?.message||'Mã không khả dụng'; }
    };
    input.addEventListener('keydown',e=>{if(e.key==='Enter')btn.click();});
    setTimeout(()=>input.focus(),50);
  }

  // ===== CLAIM =====
  async function claim(code){
    const ref=db.ref('codes/'+code);
    const res=await ref.transaction(cur=>{
      if(!cur) return cur;
      if(cur.enabled===false) return;
      if(cur.boundDeviceId && cur.boundDeviceId!==deviceId) return;
      return {...cur,boundDeviceId:deviceId,boundAt:firebase.database.ServerValue.TIMESTAMP};
    });
    if(!res.committed) throw new Error('Mã đã dùng hoặc không tồn tại');
    await db.ref('devices/'+deviceId).update({code,lastSeen:firebase.database.ServerValue.TIMESTAMP});
    LS.setItem('deviceCode',code);
    watchCode(code);
  }

  async function beat(){
    const code=LS.getItem('deviceCode')||null;
    const stage=LS.getItem('appState')||'select';
    const table=LS.getItem('tableId')||null;
    await db.ref('devices/'+deviceId).update({
      code,table,stage,inPOS:stage==='pos',
      lastSeen:firebase.database.ServerValue.TIMESTAMP
    });
  }

  function listenCmd(){
    const ref=db.ref('devices/'+deviceId+'/commands');
    ref.on('value',s=>{
      const c=s.val()||{};
      if(c.reloadAt){ LS.setItem('forceStartAfterReload','1'); location.reload(); return; }
      if(c.setTable&&c.setTable.value){
        const t=String(c.setTable.value);
        LS.setItem('tableId',t);
        gotoStart();
        db.ref('devices/'+deviceId).update({table:t});
        ref.child('setTable').remove();
      }
      if(c.unbindAt){
        LS.clear(); LS.setItem('deviceId',deviceId);
        showGate('Mã đã bị thu hồi.');
      }
    });
  }

  function watchCode(code){
    const ref=db.ref('codes/'+code);
    ref.on('value',s=>{
      const v=s.val(); if(!v||v.enabled===false||v.boundDeviceId!==deviceId){
        LS.clear(); LS.setItem('deviceId',deviceId);
        showGate('Mã bị tắt hoặc chuyển máy khác.');
      }
    });
  }

  function enterApp(){
    if(LS.getItem('forceStartAfterReload')==='1'){ LS.removeItem('forceStartAfterReload'); gotoStart(); }
    listenCmd(); beat();
  }

  document.addEventListener('DOMContentLoaded',async()=>{
    const code=LS.getItem('deviceCode');
    if(!code){ showGate(); return; }
    const v=(await db.ref('codes/'+code).once('value')).val();
    if(!v||v.enabled===false||v.boundDeviceId&&v.boundDeviceId!==deviceId){
      LS.clear(); LS.setItem('deviceId',deviceId); showGate(); return;
    }
    watchCode(code); enterApp();
    setInterval(()=>beat(),20000);
  });
})();
</body>
</html>
