<!-- b·∫£n full -->
<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>T-NGON Admin (All-in-One)</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#da251d" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-title" content="T-NGON Admin" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

<link rel="preconnect" href="https://www.gstatic.com" crossorigin>
<link rel="preconnect" href="https://www.googleapis.com" crossorigin>
<link rel="preconnect" href="https://tngon-b37d6-default-rtdb.asia-southeast1.firebasedatabase.app" crossorigin>

<!-- Icons / Manifest -->
<link rel="icon" sizes="192x192" href="./icons/icon-192.png" />
<link rel="apple-touch-icon" href="./icons/icon-192.png" />
<link rel="manifest" href="./admin.webmanifest" />

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<style>
  html, body { height: 100%; background:#f6f7f9; }
  .app-badge { font-size:12px; padding:2px 6px; border-radius:6px; border:1px solid #e5e7eb; color:#6b7280; }

  /* Toggle switch */
  .toggle input { display:none; }
  .toggle label{
    width:56px; height:32px; border-radius:999px; display:inline-block; position:relative;
    background:#e5e7eb; transition:.25s; cursor:pointer;
  }
  .toggle label::after{
    content:""; position:absolute; top:4px; left:4px; width:24px; height:24px; border-radius:999px;
    background:#fff; box-shadow:0 1px 3px rgba(0,0,0,.25); transition:.25s;
  }
  .toggle input:checked + label{ background:#10b981; }
  .toggle input:checked + label::after{ transform:translateX(24px); }
  .toggle input:disabled + label{ opacity:.5; cursor:not-allowed; }

  .toggle--sm label{ width:40px; height:22px; }
  .toggle--sm label::after{ width:18px; height:18px; top:2px; left:2px; }
  .toggle--sm input:checked + label::after{ transform:translateX(18px); }

  #devicesHeaderActions{ display:none !important; }

  /* Popup/modal fix cho iOS Safari (iPhone 17+) - d√πng absolute + transform thay flexbox */
  .modal-overlay-ios {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100% !important;
    height: 100% !important;
    min-height: 100vh !important;
    min-height: 100dvh !important;
    overflow-y: auto !important;
    -webkit-overflow-scrolling: touch !important;
    -webkit-transform: translateZ(0) !important;
    transform: translateZ(0) !important;
  }
  .modal-overlay-ios .modal-inner {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    margin: auto !important;
    width: calc(100% - 2rem) !important;
    max-width: 24rem !important;
    height: fit-content !important;
    max-height: calc(100vh - 2rem) !important;
    max-height: calc(100dvh - 2rem) !important;
    padding: 0 !important;
    box-sizing: border-box !important;
    z-index: 1 !important;
  }
  .modal-overlay-ios .modal-inner.modal-inner-xl {
    max-width: 36rem !important;
  }
  @keyframes fade-in { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  .animate-fade-in { animation: fade-in 0.2s ease-out; }
</style>
</head>
<body class="bg-gray-50">
  <!-- Admin Auth Gate (hi·ªÉn th·ªã tr∆∞·ªõc khi ƒëƒÉng nh·∫≠p) -->
  <div id="admin-auth-gate" class="fixed inset-0 z-[9999] bg-gray-100 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm">
      <h2 class="text-xl font-bold text-gray-800 mb-2">ƒêƒÉng nh·∫≠p Admin</h2>
      <p class="text-sm text-gray-500 mb-4">Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ ti·∫øp t·ª•c</p>
      <input id="admin-auth-input" type="password" placeholder="M·∫≠t kh·∫©u"
        class="w-full border rounded-lg px-4 py-3 mb-2" autocomplete="current-password" />
      <p id="admin-auth-error" class="text-red-600 text-sm mb-3 hidden"></p>
      <button id="admin-auth-btn" class="w-full py-3 rounded-lg bg-[#da251d] text-white font-semibold hover:bg-red-700">ƒêƒÉng nh·∫≠p</button>
      <p class="text-xs text-gray-400 mt-3">M·∫≠t kh·∫©u c·∫•u h√¨nh t·∫°i Firebase: config/adminPassword</p>
    </div>
  </div>

  <!-- Main content (·∫©n cho ƒë·∫øn khi ƒëƒÉng nh·∫≠p) -->
  <div id="admin-main" class="h-full flex flex-col hidden">
  <!-- Topbar -->
  <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-3 md:px-6">
    <div class="flex items-center gap-3">
      <img src="./icons/icon-72.png" alt="logo" class="w-8 h-8 rounded-md" />
      <button id="homeBtn" class="text-xl font-extrabold tracking-wide text-[#da251d]">T-NGON Admin</button>
      <span id="pwaBadge" class="app-badge hidden">Installed</span>
    </div>
    <div class="flex items-center gap-2">
      <button id="btnInstall" class="px-3 py-1.5 rounded-md bg-[#da251d] text-white text-sm hidden">C√†i ƒë·∫∑t ·ª©ng d·ª•ng</button>
      <div id="connBadge" class="text-xs text-gray-500">ƒêang ki·ªÉm tra k·∫øt n·ªëi‚Ä¶</div>
    </div>
  </header>

  <!-- Main -->
  <main class="content flex-1">
    <!-- Tabs -->
    <div class="sticky top-0 z-20 bg-white border-b border-gray-200 px-4 md:px-6 py-3">
      <div class="flex items-center gap-2">
        <button id="tabDevices"  class="px-3 py-1.5 rounded-lg bg-blue-600 text-white">Thi·∫øt b·ªã</button>
        <button id="tabCodes"    class="px-3 py-1.5 rounded-lg bg-gray-100 hover:bg-gray-200">M√£</button>
        <button id="tabSchedule" class="px-3 py-1.5 rounded-lg bg-gray-100 hover:bg-gray-200">H·∫πn gi·ªù</button>
        <button id="tabAds"      class="px-3 py-1.5 rounded-lg bg-gray-100 hover:bg-gray-200">Up ·∫£nh qu·∫£ng c√°o</button>
      </div>
    </div>

    <!-- View: Devices -->
    <section id="viewDevices" class="p-4 md:p-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Thi·∫øt b·ªã (iPad)</h2>

      <!-- Toolbar -->
      <div id="devices-toolbar" class="flex flex-wrap items-center gap-2 mb-4">
        <button id="btnReloadAll" class="px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">Reload to√†n b·ªô</button>
        <button id="btnToggleAll" class="px-3 py-2 rounded bg-gray-800 text-white hover:bg-black">T·∫Øt to√†n b·ªô</button>
        <span class="text-xs text-gray-500">‚Ä¢ T√°c ƒë·ªông to√†n b·ªô iPad</span>
      </div>

      <!-- Grid card -->
      <div id="devCards" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-2 md:gap-3"></div>
      <div id="devError" class="mt-4 hidden p-3 rounded-lg bg-red-50 text-red-700 text-sm"></div>
    </section>

    <!-- View: Codes -->
    <section id="viewCodes" class="p-4 md:p-6 hidden">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Thi·∫øt b·ªã iPad & M√£</h2>

      <div class="flex flex-col lg:flex-row gap-4">
        <!-- Add codes -->
        <div class="flex-1 bg-white rounded-xl shadow-sm border border-gray-200 p-4">
          <div class="flex items-center justify-between">
            <div class="text-lg font-semibold">Danh s√°ch M√É</div>
            <button id="btnAddCodes" class="px-3 py-1.5 rounded-md bg-blue-600 text-white hover:bg-blue-700">Th√™m m√£</button>
          </div>
          <textarea id="codesInput" class="w-full mt-3 h-40 border rounded-lg p-3 font-mono" placeholder="    "></textarea>

          <div id="codesQueueWrap" class="mt-4 hidden p-3 rounded-lg border border-emerald-200 bg-emerald-50">
            <div class="flex items-center justify-between mb-2">
              <div class="font-semibold text-emerald-800">H√†ng ƒë·ª£i m√£ kh·∫£ d·ª•ng <span id="codesQueueCount" class="text-emerald-600">(0)</span></div>
              <button id="btnCopyQueue" class="px-2 py-1 text-xs rounded bg-emerald-600 text-white hover:bg-emerald-700">Copy t·∫•t c·∫£</button>
            </div>
            <div id="codesQueue" class="flex flex-wrap gap-2 text-sm"></div>
          </div>
        </div>

        <!-- Codes table -->
        <div class="flex-1 bg-white rounded-xl shadow-sm border border-gray-200 p-4">
          <div class="text-lg font-semibold mb-3">Danh s√°ch m√£</div>
          <div class="overflow-auto">
            <table class="w-full text-sm">
              <thead class="text-left text-gray-500">
                <tr>
                  <th class="px-2 py-1">M√£</th>
                  <th class="px-2 py-1">B·∫≠t</th>
                  <th class="px-2 py-1">ƒêang g·∫Øn</th>
                  <th class="px-2 py-1">Thao t√°c</th>
                </tr>
              </thead>
              <tbody id="codesBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- View: Schedule (NEW) -->
    <section id="viewSchedule" class="p-4 md:p-6 hidden">
      <h2 class="text-2xl font-bold mb-3">H·∫πn gi·ªù b·∫≠t/t·∫Øt blackout</h2>
      <div class="space-y-3">
        <label class="flex items-center gap-2">
          <input id="sch-enabled" type="checkbox"> B·∫≠t h·∫πn gi·ªù
        </label>
        <div>
          <textarea id="sch-ranges" class="w-full h-40 border rounded p-2 font-mono text-sm"></textarea>
          <div class="text-xs text-gray-500 mt-1">
            VD: [{"days":[0,1,2,3,4,5,6],"off":"22:30","on":"08:00"}]
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button id="sch-save" class="px-3 py-2 bg-blue-600 text-white rounded">L∆∞u c·∫•u h√¨nh</button>
          <button id="sch-apply" class="px-3 py-2 bg-gray-800 text-white rounded">√Åp d·ª•ng ngay</button>
          <label class="flex items-center gap-2 text-sm">
            <input id="sch-30s" type="checkbox"> √Åp d·ª•ng 30s
          </label>
        </div>
        <div class="text-xs text-gray-500">
          ‚Ä¢ ‚ÄúL∆∞u c·∫•u h√¨nh‚Äù ch·ªâ l∆∞u l√™n Firebase.<br>
          ‚Ä¢ ‚Äú√Åp d·ª•ng ngay‚Äù s·∫Ω b·∫Øn l·ªánh t√≠nh-to√°n-tr·∫°ng-th√°i v√† √©p t·∫•t c·∫£ iPad c·∫≠p nh·∫≠t l·∫≠p t·ª©c.
        </div>
      </div>
    </section>

    <!-- View: Ads -->
    <section id="viewAds" class="p-0 hidden">
      <iframe id="ads-iframe" src="https://pic-flame.vercel.app/" referrerpolicy="no-referrer" style="width:100%;height:calc(100vh - 64px);border:0;background:#fff;"></iframe>
    </section>
  </main>

  <!-- Modal root -->
  <div id="modal-root"></div>
  </div><!-- /admin-main -->

  <script src="./assets/js/admin-auth.js?v=1"></script>
  <script src="./assets/js/admin-toast.js?v=1"></script>
  <script>
    // ===== App version =====
    const APP_VERSION = "1.3.3";

    // ===== Firebase config =====
    const firebaseConfig = {
      apiKey: "AIzaSyB4u2G41xdGkgBC0KltleRpcg5Lwru2RIU",
      authDomain: "tngon-b37d6.firebaseapp.com",
      databaseURL: "https://tngon-b37d6-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "tngon-b37d6",
      storageBucket: "tngon-b37d6.firebasestorage.app",
      messagingSenderId: "580319242104",
      appId: "1:580319242104:web:6922e4327bdc8286c30a8d",
      measurementId: "G-LHEH8ZC6SL"
    };

    // ===== Basic init + PWA =====
    const connBadge = document.getElementById('connBadge');
    const pwaBadge  = document.getElementById('pwaBadge');
    const btnInstall= document.getElementById('btnInstall');
    const homeBtn   = document.getElementById('homeBtn');
    homeBtn.addEventListener('click', ()=> location.href = location.pathname);

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw-admin.js').catch(()=>{});
    }
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault(); deferredPrompt = e; btnInstall.classList.remove('hidden');
    });
    btnInstall.addEventListener('click', async ()=> {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      btnInstall.classList.add('hidden');
      deferredPrompt = null;
    });
    window.addEventListener('appinstalled', ()=>{ pwaBadge.classList.remove('hidden'); btnInstall.classList.add('hidden'); });

    // Firebase init + connection badge
    (function initFirebase(){
      try {
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        db.ref('.info/connected').on('value', s=>{
          const ok = !!s.val();
          connBadge.textContent = ok ? 'ƒê√£ k·∫øt n·ªëi Firebase' : 'ƒêang m·∫•t k·∫øt n·ªëi Firebase';
          connBadge.className = ok ? 'text-xs text-emerald-600' : 'text-xs text-amber-600';
        });
      } catch(e) {
        connBadge.textContent = 'Firebase init l·ªói';
        connBadge.className = 'text-xs text-red-600';
        console.error(e);
      }
    })();
  </script>

  <!-- Admin schedule logic (ƒë√£ l√†m vi·ªác v·ªõi runner b√™n T-NGON app) -->
  <script src="./assets/js/admin-schedule.js"></script>

  <!-- ============ Router (tabs) ============ -->
  <script>
    (function(){
      const vDevices  = document.getElementById('viewDevices');
      const vCodes    = document.getElementById('viewCodes');
      const vSchedule = document.getElementById('viewSchedule');
      const vAds      = document.getElementById('viewAds');

      const tDevices  = document.getElementById('tabDevices');
      const tCodes    = document.getElementById('tabCodes');
      const tSchedule = document.getElementById('tabSchedule');
      const tAds      = document.getElementById('tabAds');

      function activate(btn){
        [tDevices,tCodes,tSchedule,tAds].forEach(b=>{
          b.classList.toggle('bg-blue-600', b===btn);
          b.classList.toggle('text-white', b===btn);
          b.classList.toggle('bg-gray-100', b!==btn);
        });
      }
      function show(which){
        vDevices.classList.toggle('hidden', which!=='devices');
        vCodes.classList.toggle('hidden', which!=='codes');
        vSchedule.classList.toggle('hidden', which!=='schedule');
        vAds.classList.toggle('hidden', which!=='ads');
      }
      tDevices .addEventListener('click', ()=>{ activate(tDevices ); show('devices');  });
      tCodes   .addEventListener('click', ()=>{ activate(tCodes   ); show('codes');    });
      tSchedule.addEventListener('click', ()=>{ activate(tSchedule); show('schedule'); });
      tAds     .addEventListener('click', ()=>{ activate(tAds     ); show('ads');      });
    })();
  </script>

  <!-- ============ Devices tab (inline) ============ -->
  <script>
  (function(){
    'use strict';
    const $  = (sel, root=document)=> root.querySelector(sel);
    const log= (...a)=> console.log('[devices-tab]', ...a);
    const warn=(...a)=> console.warn('[devices-tab]', ...a);
    const mask= (id)=> (!id ? '‚Äî' : (id.length<=4 ? id : id.slice(0,4)+'‚Ä¶'));
    const safeRemove = (n)=>{ 
      if (n && n.isConnected && n.parentNode) {
        n.parentNode.removeChild(n); 
        if (!document.querySelector('.modal-overlay-ios')) document.body.style.overflow = '';
      }
    };

    const view = document.getElementById('viewDevices');
    if (!view) return;

    async function ensureDB(){
      if (!window.firebase || !firebase.apps?.length) throw new Error('Firebase ch∆∞a init');
      if (!firebase.auth().currentUser){
        await firebase.auth().signInAnonymously();
        await new Promise(res=>{
          const un=firebase.auth().onAuthStateChanged(u=>{ if(u){ un(); res(); }});
        });
      }
      return firebase.database();
    }

    // links.json (optional ‚Äì ƒë·ªÉ build l∆∞·ªõi b√†n gi·ªëng app)
    let LINKS_MAP = null;
    async function loadLinks(){
      try{
        const res = await fetch('./links.json?cb='+Date.now(), { cache:'no-store' });
        const data = await res.json();
        LINKS_MAP = data.links || data;
      }catch(e){ LINKS_MAP=null; warn('Kh√¥ng t·∫£i ƒë∆∞·ª£c links.json'); }
    }
    function openTablePicker(onPick){
      const keys = LINKS_MAP ? Object.keys(LINKS_MAP).sort((a,b)=>Number(a)-Number(b))
                             : Array.from({length:15},(_,i)=> String(i+1));
      const wrap = document.createElement('div');
      wrap.className = 'modal-overlay-ios fixed inset-0 z-[10500] bg-black/50 p-4';
      wrap.innerHTML = `
        <div class="modal-inner modal-inner-xl">
          <div class="bg-white rounded-xl shadow-lg w-full p-4">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-lg font-semibold">Ch·ªçn b√†n</h3>
              <button id="tp-close" class="px-2 py-1 text-sm rounded border hover:bg-gray-50">ƒê√≥ng</button>
            </div>
            <div id="tp-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2 max-h-[70vh] overflow-auto"></div>
          </div>
        </div>`;
      document.body.appendChild(wrap);
      document.body.style.overflow = 'hidden';
      window.scrollTo(0, 0);
      const grid = wrap.querySelector('#tp-grid');
      keys.forEach(k=>{
        const b=document.createElement('button');
        b.className='px-3 py-3 rounded-lg border text-sm font-semibold hover:bg-blue-50';
        b.textContent='B√†n '+k;
        b.addEventListener('click', ()=>{ try{ onPick(k); } finally { safeRemove(wrap); }});
        grid.appendChild(b);
      });
      wrap.querySelector('#tp-close').addEventListener('click', ()=> safeRemove(wrap));
    }

    // per-table screen state cache
    const tableScreen = {}; // { "1": "on"/"off" }
    let devicesCache = {};

    function tableIsOn(table){
      const v = tableScreen[String(table)];
      return (String(v||'on').toLowerCase() === 'on');
    }
    function cardClass(isOn){
      return isOn
        ? 'rounded-xl border border-emerald-200 bg-emerald-50 p-3 shadow-sm cursor-pointer transition'
        : 'rounded-xl border border-gray-300 bg-gray-100 p-3 shadow-sm cursor-pointer transition';
    }

    function openActionPopup(db, id, data){
      const code  = data?.code  || '';
      const name  = data?.name  || '';
      const stage = data?.stage || 'select';
      const table = data?.table || '';

      const wrap = document.createElement('div');
      wrap.className = 'modal-overlay-ios fixed inset-0 z-[9700] bg-black/50 p-4';
      wrap.innerHTML = `
        <div class="modal-inner">
          <div class="bg-white rounded-2xl shadow-xl w-full p-5">
            <div class="flex items-center justify-between mb-3">
              <div class="font-semibold">Thi·∫øt b·ªã ${mask(id)}</div>
              <button id="devact-close" class="px-2 py-1 text-sm rounded border hover:bg-gray-50">ƒê√≥ng</button>
            </div>

            <div class="text-sm text-gray-600 mb-3">
              <div>T√™n hi·ªán t·∫°i: <strong>${name || '(ch∆∞a ƒë·∫∑t)'}</strong>
                <button id="act-rename" class="ml-1 px-2 py-0.5 text-xs rounded border hover:bg-gray-50">ƒê·ªïi t√™n</button>
              </div>
              <div>M√£ ƒëang g·∫Øn: <span class="font-mono">${code || '‚Äî'}</span></div>
              <div>B√†n: <strong>${stage==='pos' ? ('+'+(table||'?')) : (stage==='start'? (table||'‚Äî') : '‚Äî')}</strong></div>
            </div>

            <div class="grid grid-cols-2 gap-2">
              <button id="act-reload"  class="px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">L√†m m·ªõi</button>
              <button id="act-settbl" class="px-3 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700">ƒê·ªïi b√†n</button>
              <button id="act-unbind" class="px-3 py-2 rounded bg-orange-500 text-white hover:bg-orange-600" ${code?'':'disabled'}>G·ª° m√£</button>
              <button id="act-delete" class="px-3 py-2 rounded ${code?'bg-gray-100 opacity-50 cursor-not-allowed':'bg-red-600 text-white hover:bg-red-700'}" ${code?'disabled':''}>Xo√° device</button>
            </div>
          </div>
        </div>`;
      document.body.appendChild(wrap);
      document.body.style.overflow = 'hidden';
      window.scrollTo(0, 0);
      $('#devact-close', wrap).addEventListener('click', ()=> safeRemove(wrap));

      // ƒê·ªïi t√™n
      $('#act-rename', wrap).addEventListener('click', async ()=>{
        const v = prompt('Nh·∫≠p t√™n m√°y (ƒë·ªÉ tr·ªëng ƒë·ªÉ xo√°):', name || '');
        if (v === null) return;
        try{
          const newName = String(v).trim();
          if (newName) await db.ref(`devices/${id}/name`).set(newName);
          else await db.ref(`devices/${id}/name`).remove();
          safeRemove(wrap);
        }catch(e){ (window.adminToast?.showError||alert)('ƒê·∫∑t t√™n l·ªói: '+(e?.message||e)); }
      });

      // Reload
      $('#act-reload', wrap).addEventListener('click', async ()=>{
        try{
          await db.ref(`devices/${id}/commands/reloadAt`).set(firebase.database.ServerValue.TIMESTAMP);
          safeRemove(wrap);
        }catch(e){ (window.adminToast?.showError||alert)('G·ª≠i reload l·ªói: '+(e?.message||e)); }
      });

      // ƒê·ªïi b√†n
      $('#act-settbl', wrap).addEventListener('click', ()=>{
        openTablePicker(async (label)=>{
          try{
            await db.ref(`devices/${id}/commands/setTable`).set({ value: label, at: firebase.database.ServerValue.TIMESTAMP });
            await db.ref(`devices/${id}`).update({ table: label, stage:'start' });
          }catch(e){ (window.adminToast?.showError||alert)('ƒê·ªïi b√†n l·ªói: '+(e?.message||e)); }
          safeRemove(wrap);
        });
      });

      // G·ª° m√£
      $('#act-unbind', wrap)?.addEventListener('click', async ()=>{
        if (!code) return;
        const verify = prompt(`Nh·∫≠p l·∫°i M√É ƒëang g·∫Øn ƒë·ªÉ g·ª° (m√£ hi·ªán t·∫°i: ${code}):`);
        if (verify === null) return;
        if (String(verify).trim().toUpperCase() !== String(code).toUpperCase()){
          alert('M√£ x√°c nh·∫≠n kh√¥ng kh·ªõp.'); return;
        }
        try{
          await db.ref('codes/'+code).transaction(cur=>{
            if (!cur) return cur;
            if (cur.boundDeviceId === id) return { ...cur, boundDeviceId:null, boundAt:null };
            return cur;
          });
          await db.ref(`devices/${id}/commands/unbindAt`).set(firebase.database.ServerValue.TIMESTAMP);
          await db.ref(`devices/${id}`).update({ code:null, table:null, stage:'select' });
          safeRemove(wrap);
        }catch(e){ (window.adminToast?.showError||alert)('G·ª° li√™n k·∫øt l·ªói: '+(e?.message||e)); }
      });

      // Xo√° device
      $('#act-delete', wrap).addEventListener('click', async ()=>{
        if (code) return;
        if (!confirm('Xo√° thi·∫øt b·ªã kh·ªèi danh s√°ch?')) return;
        try{ await db.ref(`devices/${id}`).remove(); safeRemove(wrap); }
        catch(e){ (window.adminToast?.showError||alert)('Xo√° device l·ªói: '+(e?.message||e)); }
      });
    }
function renderGrid(grid, db, devices) {
  grid.innerHTML = '';

  const entries = Object.entries(devices || {}).sort((a, b) => {
    const ta = parseInt(a[1]?.table || '99999', 10);
    const tb = parseInt(b[1]?.table || '99999', 10);
    if (isFinite(ta) && isFinite(tb) && ta !== tb) return ta - tb;
    return a[0].localeCompare(b[0]);
  });

  if (!entries.length) {
    const p = document.createElement('div');
    p.className = 'text-center text-sm text-gray-500 py-3';
    p.textContent = 'Ch∆∞a c√≥ thi·∫øt b·ªã n√†o.';
    grid.appendChild(p);
    return;
  }

  for (const [id, d] of entries) {
    const name    = d?.name || '';
    const table   = String(d?.table || '');
    const stage   = d?.stage || '';
    const hasTable= !!table && !isNaN(parseInt(table, 10));

    // tr·∫°ng th√°i hi·ªÉn th·ªã ∆∞u ti√™n t·ª´ tableScreen (ƒë√£ ƒë∆∞·ª£c ƒë·ªï b·ªüi status/tables)
    const isOn    = hasTable ? tableIsOn(table) : true;

    // üëâ Hi·ªÉn th·ªã s·ªë b√†n: n·∫øu ƒëang POS th√¨ th√™m "+"
    const tableLabel   = table ? String(table).replace('+','') : '';
    const displayTable = tableLabel ? (stage === 'pos' ? `+${tableLabel}` : tableLabel) : '‚Äî';

    const card = document.createElement('div');
    card.className = cardClass(isOn) + ' aspect-[4/3] p-2 md:p-3 flex';

    card.innerHTML = `
      <div class="relative flex-1 flex flex-col">
        <div class="flex items-center justify-between mb-1">
          <div class="min-w-0 text-[10px] md:text-[20px] font-semibold text-gray-700 truncate" title="${name || '(ch∆∞a ƒë·∫∑t)'}">
            ${name || '(ch∆∞a ƒë·∫∑t)'}
          </div>
          <div class="select-none" data-role="switch-wrap">
            <div class="toggle toggle--sm ${hasTable ? '' : 'opacity-50'}">
              <input type="checkbox" id="sw-${id}" ${isOn ? 'checked' : ''} ${hasTable ? '' : 'disabled'}>
              <label for="sw-${id}" aria-label="B·∫≠t/T·∫Øt theo b√†n"></label>
            </div>
          </div>
        </div>

        <div class="flex-1 flex items-center justify-center">
          <div class="text-center leading-none">
            <div class="font-extrabold text-3xl md:text-4xl lg:text-5xl">
              ${displayTable}
            </div>
          </div>
        </div>
      </div>
    `;

    // Click card -> m·ªü popup thao t√°c device
    card.addEventListener('click', ()=> openActionPopup(db, id, d));

    // Ch·∫∑n click v√†o c√¥ng t·∫Øc m·ªü popup
    const swWrap = card.querySelector('[data-role="switch-wrap"]');
    swWrap?.addEventListener('click', (ev)=> ev.stopPropagation());

    // G·ª≠i ƒëi·ªÅu khi·ªÉn √ù ƒê·ªäNH (control/tables/<table>/screen) khi g·∫°t c√¥ng t·∫Øc
    const sw = card.querySelector(`#sw-${CSS.escape(id)}`);
    sw?.addEventListener('change', async (e)=>{
      if (!hasTable){ sw.checked = isOn; return; }
      try{
        const wantOn = !!e.target.checked;
        // √ù ƒê·ªäNH ghi v√†o control (ƒë·ªÉ schedule/tngon ƒë·ªçc)
        await db.ref(`control/tables/${table}/screen`).set(wantOn ? 'on' : 'off');
        // T√¥ l·∫°i theo tr·∫°ng th√°i c√¥ng t·∫Øc ngay (UI), c√≤n th·ª±c t·∫ø s·∫Ω ƒë∆∞·ª£c status/tables ƒë·ªï v·ªÅ sau
        tableScreen[String(table)] = wantOn ? 'on' : 'off';
        card.className = cardClass(wantOn) + ' aspect-[4/3] p-2 md:p-3 flex';
      }catch(err){
        (window.adminToast?.showError||alert)('Ghi tr·∫°ng th√°i b√†n l·ªói: ' + (err?.message || err));
        sw.checked = !sw.checked;
      }
    });

    grid.appendChild(card);
  }
}

    document.addEventListener('DOMContentLoaded', async ()=>{
      try{
        const db = await ensureDB();
        await loadLinks();

        const grid = document.getElementById('devCards');

        // Toolbar
        const refScreen = db.ref('control/screen');
        const paintToggleAll = (isOn)=>{
          const btn = document.getElementById('btnToggleAll');
          if (!btn) return;
          if (isOn){
            btn.textContent='T·∫Øt to√†n b·ªô';
            btn.className='px-3 py-2 rounded bg-gray-800 text-white hover:bg-black';
          } else {
            btn.textContent='B·∫≠t to√†n b·ªô';
            btn.className='px-3 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700';
          }
        };
        refScreen.on('value', s=>{
          const isOn = (s.exists()? String(s.val()).toLowerCase() : 'on')==='on';
          paintToggleAll(isOn);
        });

        document.getElementById('btnReloadAll')?.addEventListener('click', async ()=>{
          try{ await (window.adminToast?.withRetry||(f=>f()))(()=> db.ref('broadcast/reloadAt').set(firebase.database.ServerValue.TIMESTAMP)); (window.adminToast?.showSuccess||(()=>{}))('ƒê√£ g·ª≠i reload'); }
          catch(e){ (window.adminToast?.showError||alert)('Reload to√†n b·ªô l·ªói: '+(e?.message||e)); }
        });
        document.getElementById('btnToggleAll')?.addEventListener('click', async ()=>{
          const snap = await refScreen.get();
          const on = (snap.exists()? String(snap.val()).toLowerCase() : 'on')==='on';
          try{
            if (on){
              await refScreen.set('off');
              const updates={};
              for(let i=1;i<=15;i++){ updates[`control/tables/${i}/screen`]='off'; tableScreen[String(i)]='off'; }
              await db.ref().update(updates);
            } else {
              await refScreen.set('on');
              const updates={};
              for(let i=1;i<=15;i++){ updates[`control/tables/${i}/screen`]='on'; tableScreen[String(i)]='on'; }
              await db.ref().update(updates);
            }
            if (grid && devicesCache) renderGrid(grid, db, devicesCache);
          }catch(e){ (window.adminToast?.showError||alert)('Ghi tr·∫°ng th√°i to√†n b·ªô l·ªói (c√≥ th·ªÉ th·ª≠ l·∫°i): '+(e?.message||e)); }
        });

        // Subscribe devices
        db.ref('devices').on('value', s=>{
          devicesCache = s.val() || {};
          renderGrid(grid, db, devicesCache);
        }, e=> (window.adminToast?.showError||alert)('L·ªói subscribe devices: '+(e?.message||e)));

        // 1) √ù ƒë·ªãnh (c≈©): control/tables  -> on|off (fallback)
db.ref('control/tables').on('value', s=>{
  const v = s.val() || {};
  Object.keys(v).forEach(k=>{
    // c√≥ n∆°i l∆∞u 'screen' ho·∫∑c value th·∫≥ng; normalize:
    const raw = v[k];
    const st  = (typeof raw === 'string') ? raw : (raw?.screen || 'on');
    tableScreen[String(k)] = (String(st).toLowerCase()==='off') ? 'off' : 'on';
  });
  if (grid && devicesCache) renderGrid(grid, db, devicesCache);
}, e=> console.warn('L·ªói subscribe control/tables:', e?.message||e));

// 2) TR·∫†NG TH√ÅI TH·∫¨T (m·ªõi): status/tables  -> state:'on'|'off' (∆ØU TI√äN)
db.ref('status/tables').on('value', s=>{
  const v = s.val() || {};
  Object.keys(v).forEach(k=>{
    const st = (v[k]?.screen?.state === 'off') ? 'off' : 'on';
    tableScreen[String(k)] = st; // üëà ghi ƒë√® ƒë·ªÉ ∆∞u ti√™n tr·∫°ng th√°i th·ª±c t·∫ø
  });
  if (grid && devicesCache) renderGrid(grid, db, devicesCache);
}, e=> console.warn('L·ªói subscribe status/tables:', e?.message||e));
        
        // Subscribe per-table screen state
        db.ref('control/tables').on('value', s=>{
          const v = s.val()||{};
          Object.keys(v).forEach(k=> tableScreen[String(k)] = (v[k]?.screen || v[k]));
          if (grid && devicesCache) renderGrid(grid, db, devicesCache);
        }, e=> console.warn('L·ªói subscribe control/tables:', e?.message||e));

        log('Devices tab ready.');
      }catch(e){
        console.error(e);
        (window.adminToast?.showError||alert)('L·ªói kh·ªüi ch·∫°y tab Thi·∫øt b·ªã: '+(e?.message||e));
      }
    });
  })();
  </script>

  <!-- ============ Codes tab (inline) ============ -->
  <script>
  (function(){
    'use strict';
    const $ = (id)=> document.getElementById(id);
    const tbody = $('codesBody');
    const input = $('codesInput');
    const errBox= $('devError') || document.getElementById('codesError');

    let db=null;
    function showErr(m){ if(!errBox) return; errBox.textContent=m||''; errBox.classList.toggle('hidden', !m); }

    async function ensureFirebase(){
      if (!window.firebase || !firebase.apps?.length) throw new Error('Firebase ch∆∞a kh·ªüi t·∫°o');
      db = firebase.database();
      if (!firebase.auth().currentUser){
        await firebase.auth().signInAnonymously();
        await new Promise(res=>{
          const un = firebase.auth().onAuthStateChanged(u=>{ if(u){ un(); res(); }});
        });
      }
    }

    function renderQueue(codes){
      const wrap = document.getElementById('codesQueueWrap');
      const list = document.getElementById('codesQueue');
      const count= document.getElementById('codesQueueCount');
      if (!wrap || !list) return;

      const avail = Object.entries(codes||{})
        .filter(([_,v])=> v && v.enabled!==false && !v.boundDeviceId)
        .map(([k])=>k).sort((a,b)=> a.localeCompare(b));

      list.innerHTML = '';
      avail.forEach(code=>{
        const span = document.createElement('span');
        span.className = 'px-2 py-1 rounded-md bg-emerald-100 text-emerald-800 border border-emerald-300';
        span.textContent = code;
        list.appendChild(span);
      });
      wrap.classList.toggle('hidden', avail.length===0);
      if (count) count.textContent = `(${avail.length})`;
    }

    function renderCodes(codes){
      if (!tbody) return;
      tbody.innerHTML = '';
      renderQueue(codes);
      Object.entries(codes||{}).sort(([a],[b])=> a.localeCompare(b)).forEach(([code,v])=>{
        const enabled = v?.enabled!==false;
        const boundId = v?.boundDeviceId || null;
        const tr = document.createElement('tr');
        tr.className='border-b last:border-0';
        tr.innerHTML = `
          <td class="px-2 py-1 font-mono">${code}</td>
          <td class="px-2 py-1">
            <span class="inline-flex items-center gap-1 text-xs ${enabled?'text-emerald-700':'text-red-600'}">
              <span class="w-2 h-2 rounded-full ${enabled?'bg-emerald-500':'bg-red-500'}"></span>${enabled?'ON':'OFF'}
            </span>
          </td>
          <td class="px-2 py-1 text-xs break-all">${boundId||'‚Äî'}</td>
          <td class="px-2 py-1">
            <div class="flex flex-wrap gap-2">
              <button class="px-2 py-1 text-xs rounded bg-gray-800 text-white hover:bg-black" data-act="toggle">${enabled?'T·∫Øt m√£':'B·∫≠t m√£'}</button>
              <button class="px-2 py-1 text-xs rounded bg-red-600 text-white hover:bg-red-700" data-act="delete">X√≥a m√£</button>
            </div>
          </td>`;
        tr.querySelector('[data-act="toggle"]').addEventListener('click', async ()=>{
          try{
            const next = !enabled;
            await db.ref('codes/'+code+'/enabled').set(next);
            if (boundId && next===false){
              await db.ref(`devices/${boundId}/commands/unbindAt`).set(firebase.database.ServerValue.TIMESTAMP);
            }
          }catch(e){ showErr('ƒê·ªïi tr·∫°ng th√°i m√£ l·ªói: '+(e?.message||e)); }
        });
        tr.querySelector('[data-act="delete"]').addEventListener('click', async ()=>{
          if (!confirm(`X√≥a m√£ ${code}?`)) return;
          try{
            if (boundId){
              await db.ref(`devices/${boundId}/commands/unbindAt`).set(firebase.database.ServerValue.TIMESTAMP);
            }
            await db.ref('codes/'+code).remove();
          }catch(e){ showErr('X√≥a m√£ l·ªói: '+(e?.message||e)); }
        });

        tbody.appendChild(tr);
      });
    }

    async function addCodes(){
      const raw = (input?.value||'').trim();
      if (!raw) return alert('D√°n danh s√°ch m√£ (m·ªói d√≤ng 1 m√£)');
      const lines = raw.split(/\r?\n/).map(s=>s.trim().toUpperCase()).filter(Boolean);
      if (!lines.length) return alert('Kh√¥ng c√≥ m√£ h·ª£p l·ªá');
      const updates = {};
      const now = firebase.database.ServerValue.TIMESTAMP;
      for (const code of lines){
        updates['codes/'+code] = { enabled:true, boundDeviceId:null, boundAt:null, createdAt:now };
      }
      try{
        await db.ref().update(updates);
        input.value='';
        alert('ƒê√£ th√™m '+lines.length+' m√£');
      }catch(e){ showErr('Th√™m m√£ l·ªói: '+(e?.message||e)); }
    }

    document.addEventListener('DOMContentLoaded', async ()=>{
      try{
        await ensureFirebase();
        firebase.database().ref('codes').on('value', s=> renderCodes(s.val()||{}), e=> showErr('L·ªói t·∫£i m√£: '+(e?.message||e)));
        document.getElementById('btnAddCodes')?.addEventListener('click', addCodes);
        document.getElementById('btnCopyQueue')?.addEventListener('click', ()=>{
          const list = document.getElementById('codesQueue'); if (!list) return;
          const items = Array.from(list.childNodes).map(x=>x.textContent.trim()).filter(Boolean);
          if (!items.length) return alert('Kh√¥ng c√≥ m√£ kh·∫£ d·ª•ng');
          navigator.clipboard.writeText(items.join('\n')).then(()=> alert('ƒê√£ copy.'));
        });
      }catch(e){
        console.error(e);
        showErr('L·ªói kh·ªüi ch·∫°y: '+(e?.message||e));
      }
    });
  })();
  </script>
<script src="./assets/js/admin-home-inject.js?v=1"></script>
</body>
</html>
