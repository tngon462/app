<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin — Device Codes & Remote Control</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="max-w-6xl mx-auto p-4 space-y-6">
    <h1 class="text-2xl font-extrabold">Admin — Quản lý iPad theo MÃ</h1>

    <!-- Firebase Config (tùy bạn import firebase.js riêng) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script>
      const firebaseConfig = {/* TODO: cấu hình của bạn */};
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      firebase.auth().signInAnonymously();

      const db = firebase.database();

      // ===== Helpers =====
      const $ = (q,root=document)=>root.querySelector(q);
      const $$ = (q,root=document)=>Array.from(root.querySelectorAll(q));
      function nowTS(){ return Date.now(); }
      function tsToAgo(ts){ if(!ts) return '-'; const s=Math.floor((Date.now()-ts)/1000); if(s<60) return s+"s"; const m=Math.floor(s/60); if(m<60) return m+"m"; const h=Math.floor(m/60); if(h<24) return h+"h"; return Math.floor(h/24)+"d"; }

      // ===== UI Refs =====
      const codesTbody = document.createElement('tbody');
      const devicesTbody = document.createElement('tbody');

      document.addEventListener('DOMContentLoaded', ()=>{
        $('#codes-tbody').replaceWith(codesTbody); codesTbody.id='codes-tbody';
        $('#devices-tbody').replaceWith(devicesTbody); devicesTbody.id='devices-tbody';
        bindUI(); loadLive();
      });

      function bindUI(){
        $('#btn-broadcast-reload').addEventListener('click', async ()=>{
          await db.ref('broadcast').update({ reloadAt: firebase.database.ServerValue.TIMESTAMP });
          alert('Đã gửi lệnh reload toàn bộ');
        });

        $('#btn-import-codes').addEventListener('click', async ()=>{
          const raw = $('#codes-import').value.trim();
          if (!raw) return alert('Dán danh sách mã (mỗi dòng 1 mã)');
          const lines = raw.split(/\r?\n/).map(s=>s.trim().toUpperCase()).filter(Boolean);
          const updates = {};
          for (const code of lines){ updates['codes/'+code] = { enabled: true, boundDeviceId: null, createdAt: firebase.database.ServerValue.TIMESTAMP, boundAt: null }; }
          await db.ref().update(updates);
          alert('Đã import '+lines.length+' mã');
          $('#codes-import').value='';
        });
      }

      function loadLive(){
        // Live codes
        db.ref('codes').on('value', snap=>{
          const data = snap.val()||{}; renderCodes(data);
        });
        // Live devices
        db.ref('devices').on('value', snap=>{
          const data = snap.val()||{}; renderDevices(data);
        });
      }

      function renderCodes(codes){
        codesTbody.innerHTML = '';
        const entries = Object.entries(codes).sort((a,b)=> (a[0]>b[0]?1:-1));
        for (const [code, obj] of entries){
          const tr = document.createElement('tr');
          tr.className = 'border-b';
          tr.innerHTML = `
            <td class="px-2 py-1 font-mono text-sm">${code}</td>
            <td class="px-2 py-1">${obj.enabled?'<span class="text-green-700">ON</span>':'<span class="text-gray-400">OFF</span>'}</td>
            <td class="px-2 py-1">${obj.boundDeviceId?`<span class="text-blue-700">${obj.boundDeviceId}</span>`:'-'}</td>
            <td class="px-2 py-1">${obj.boundAt?tsToAgo(obj.boundAt):'-'}</td>
            <td class="px-2 py-1 space-x-2">
              <button class="px-2 py-1 bg-gray-200 rounded" data-act="toggle">${obj.enabled?'Tắt':'Bật'}</button>
              <button class="px-2 py-1 bg-yellow-200 rounded" data-act="unbind" ${obj.boundDeviceId?'':'disabled'}>Gỡ liên kết</button>
              <button class="px-2 py-1 bg-red-200 rounded" data-act="delete">Xóa mã</button>
            </td>`;

          tr.querySelector('[data-act="toggle"]').addEventListener('click',()=>{
            db.ref('codes/'+code).update({ enabled: !obj.enabled });
          });
          tr.querySelector('[data-act="unbind"]').addEventListener('click',()=>{
            db.ref('codes/'+code).transaction(v=> v?{...v, boundDeviceId:null, boundAt:null}:v);
          });
          tr.querySelector('[data-act="delete"]').addEventListener('click',async()=>{
            if (!confirm('Xóa mã '+code+'?')) return;
            await db.ref('codes/'+code).remove();
          });

          codesTbody.appendChild(tr);
        }
      }

      function render
