# QRback_test_v2.py - Server WebSocket vá»›i chá»©c nÄƒng thÃ´ng bÃ¡o háº¿t háº¡n mÃ£ QR

import asyncio
import websockets
import json
import time

# Dictionary Ä‘á»ƒ lÆ°u trá»¯ cÃ¡c káº¿t ná»‘i client theo sá»‘ bÃ n
connected_clients = {}

async def handler(websocket):
    """
    Xá»­ lÃ½ káº¿t ná»‘i tá»« client WebSocket.
    """
    client_address = websocket.remote_address
    print(f"--- Client má»›i káº¿t ná»‘i tá»« {client_address} ---")
    
    try:
        # Chá» tin nháº¯n Ä‘áº§u tiÃªn tá»« client Ä‘á»ƒ xÃ¡c Ä‘á»‹nh bÃ n
        # Tin nháº¯n nÃ y pháº£i cÃ³ Ä‘á»‹nh dáº¡ng {"action": "client_connected", "ban": 10}
        initial_message = await asyncio.wait_for(websocket.recv(), timeout=10.0)
        message_data = json.loads(initial_message)
        
        ban_id = message_data.get("ban")
        action = message_data.get("action")
        
        if action == "client_connected" and ban_id:
            print(f"âœ… ÄÃ£ xÃ¡c Ä‘á»‹nh: Client á»Ÿ BÃ n {ban_id} Ä‘Ã£ káº¿t ná»‘i.")
            connected_clients[ban_id] = websocket
            
            # Gá»­i má»™t tin nháº¯n xÃ¡c nháº­n ngay láº­p tá»©c cho client nÃ y
            await websocket.send(json.dumps({"ban": ban_id, "test_message": "connected"}))
            print(f"âœ… ÄÃ£ gá»­i tin nháº¯n xÃ¡c nháº­n Ä‘áº¿n BÃ n {ban_id}.")
        else:
            print(f"âŒ Nháº­n tin nháº¯n khÃ´ng há»£p lá»‡: {initial_message}. ÄÃ³ng káº¿t ná»‘i.")
            await websocket.close(code=1003, reason="Invalid message format")
            return

        # VÃ²ng láº·p Ä‘á»ƒ nháº­n cÃ¡c tin nháº¯n khÃ¡c tá»« client
        async for message in websocket:
            print(f"â¡ï¸ Nháº­n tin nháº¯n tá»« BÃ n {ban_id}: {message}")
            # á» Ä‘Ã¢y báº¡n cÃ³ thá»ƒ thÃªm logic xá»­ lÃ½ tin nháº¯n trong tÆ°Æ¡ng lai
            
    except asyncio.TimeoutError:
        print(f"âŒ Lá»—i: KhÃ´ng nháº­n Ä‘Æ°á»£c tin nháº¯n xÃ¡c Ä‘á»‹nh bÃ n trong 10 giÃ¢y. ÄÃ³ng káº¿t ná»‘i.")
    except websockets.exceptions.ConnectionClosed as e:
        print(f"--- Client BÃ n {ban_id} Ä‘Ã£ ngáº¯t káº¿t ná»‘i. MÃ£ lá»—i: {e.code}, LÃ½ do: {e.reason} ---")
    except json.JSONDecodeError:
        print("âŒ Lá»—i: KhÃ´ng thá»ƒ phÃ¢n tÃ­ch cÃº phÃ¡p tin nháº¯n JSON. ÄÃ³ng káº¿t ná»‘i.")
    except Exception as e:
        print(f"âŒ Lá»—i khÃ´ng xÃ¡c Ä‘á»‹nh: {e}")
    finally:
        # XÃ³a client khi ngáº¯t káº¿t ná»‘i
        if ban_id in connected_clients:
            del connected_clients[ban_id]
            print(f"--- ÄÃ£ xÃ³a BÃ n {ban_id} khá»i danh sÃ¡ch káº¿t ná»‘i ---")

async def send_expired_message(ban_id):
    """
    Gá»­i tin nháº¯n háº¿t háº¡n tá»›i má»™t client cá»¥ thá»ƒ.
    """
    if ban_id in connected_clients:
        websocket = connected_clients[ban_id]
        try:
            message = json.dumps({"action": "expired"})
            await websocket.send(message)
            print(f"ğŸ“¢ ÄÃ£ gá»­i tin nháº¯n háº¿t háº¡n Ä‘áº¿n BÃ n {ban_id}.")
            return True
        except websockets.exceptions.ConnectionClosed as e:
            print(f"âŒ Lá»—i: KhÃ´ng thá»ƒ gá»­i tin nháº¯n. Káº¿t ná»‘i Ä‘áº¿n BÃ n {ban_id} Ä‘Ã£ Ä‘Ã³ng. MÃ£ lá»—i: {e.code}")
            return False
    else:
        print(f"âš ï¸ KhÃ´ng tÃ¬m tháº¥y káº¿t ná»‘i cho BÃ n {ban_id}.")
        return False

async def simulate_expiry():
    """
    HÃ m mÃ´ phá»ng viá»‡c mÃ£ QR háº¿t háº¡n cho bÃ n 10.
    """
    # Chá» 30 giÃ¢y Ä‘á»ƒ mÃ´ phá»ng má»™t khoáº£ng thá»i gian trÆ°á»›c khi háº¿t háº¡n
    await asyncio.sleep(30)
    print("\n--- MÃ” PHá»NG: ÄÃ£ háº¿t thá»i gian sá»­ dá»¥ng mÃ£ QR cho BÃ n 10 ---")
    await send_expired_message(10)

async def main():
    """
    Khá»Ÿi Ä‘á»™ng server WebSocket vÃ  má»™t hÃ m mÃ´ phá»ng.
    """
    # Khá»Ÿi Ä‘á»™ng server
    server_task = websockets.serve(handler, "0.0.0.0", 8765)
    
    # Khá»Ÿi Ä‘á»™ng hÃ m mÃ´ phá»ng háº¿t háº¡n
    expiry_task = simulate_expiry()

    print("ğŸš€ Server WebSocket Ä‘ang cháº¡y táº¡i ws://0.0.0.0:8765...")
    print("HÃ£y cháº¡y file redirect_test.html trÃªn tablet vÃ  chá»n sá»‘ bÃ n.")
    print("MÃ´ phá»ng: Tin nháº¯n háº¿t háº¡n sáº½ Ä‘Æ°á»£c gá»­i Ä‘áº¿n BÃ n 10 sau 30 giÃ¢y.")
    
    # Cháº¡y cáº£ hai tÃ¡c vá»¥ Ä‘á»“ng thá»i
    await asyncio.gather(server_task, expiry_task)

if __name__ == "__main__":
    asyncio.run(main())
