<!DOCTYPE html>
<html>
<head>
Â  <meta charset="UTF-8" />
Â  <title>T-NGON</title>
Â  <meta name="viewport" content="width=device-width, initial-scale=1" />

Â  Â  <link rel="manifest" href="manifest.json" />
Â  <link rel="icon" href="https://placehold.co/192x192/da251d/fff?text=TN" />
Â  <link rel="apple-touch-icon" href="https://placehold.co/192x192/da251d/fff?text=TN" />
Â  <meta name="apple-mobile-web-app-title" content="T-NGON" />
Â  <meta name="apple-mobile-web-app-capable" content="yes" />
Â  <meta name="mobile-web-app-capable" content="yes" />
Â  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
Â  <meta name="theme-color" content="#da251d" />

Â  Â  <script src="https://cdn.tailwindcss.com"></script>

Â  Â  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

Â  <style>
Â  Â  body { font-family: "Inter", system-ui, sans-serif; margin: 0; padding: 0; background: #f3f4f6; }
Â  Â  .main-container { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; width: 100vw; padding: 1rem; box-sizing: border-box; }
Â  Â  .screen { display: none; flex-direction: column; justify-content: center; align-items: center; width: 100%; height: 100%; }
Â  Â  #table-selection-screen { display: flex; }
Â  Â  .button-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; max-width: 600px; margin: 2rem auto 0; }
Â  Â  .table-button { font-size: 2rem; font-weight: 700; padding: 2rem 1rem; background: #007aff; color: #fff; border: 2px solid #007aff; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,.1), 0 2px 4px -1px rgba(0,0,0,.06); cursor: pointer; transition: all .2s ease; }
Â  Â  .table-button:active { transform: translateY(1px); }
Â  Â  .start-button { font-size: 2.5rem; padding: 1.25rem 2.5rem; background: #007aff; color: #fff; border: none; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,.1), 0 2px 4px -1px rgba(0,0,0,.06); cursor: pointer; transition: all .2s ease; }
Â  Â  .start-button:active { transform: translateY(1px); }
Â  Â  .iframe-container { width: 100%; height: 100%; border: none; overflow: hidden; }
Â  Â  .loading-indicator { font-size: 1.5rem; color: #6b7280; margin-top: 1rem; }
Â  Â  .error-message { color: #ef4444; font-size: 1.2rem; margin-top: 1rem; }
Â  Â  @media (max-width: 640px) {
Â  Â  Â  .button-grid { grid-template-columns: repeat(2, 1fr); gap: 1rem; }
Â  Â  Â  .table-button { font-size: 1.5rem; padding: 1.5rem .5rem; }
Â  Â  Â  .start-button { font-size: 2rem; padding: 1rem 2rem; }
Â  Â  }
Â  Â  .return-button { position: absolute; bottom: 10px; left: 10px; width: 24px; height: 24px; padding: 0; background: transparent; border: none; cursor: pointer; z-index: 100; }
Â  Â  /* ===== Slideshow (ná»n tráº¯ng, khÃ´ng caption) ===== */
Â  Â  #start-slideshow-screen { position: relative; width:100%; height:100%; background:#ffffff; overflow:hidden; }
Â  Â  .slide-stage { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:#ffffff; }
Â  Â  .slide-stage img, .slide-stage video { max-width:100%; max-height:100%; width:auto; height:auto; object-fit:contain; background:#ffffff; }
Â  Â  .tap-overlay { position:absolute; inset:0; z-index:10; cursor:pointer; }
Â  Â  .slide-status { position:absolute; top:10px; right:10px; z-index:20; background: rgba(220, 38, 38, 0.9); color:#fff; padding: 6px 10px; border-radius: 6px; font-size: 12px; display:none; max-width: 70vw; line-height: 1.3; }
Â  Â  #global-status { display:none; font-size:12px; color:#ef4444; margin-top:8px; }
Â  </style>
</head>
<body class="bg-gray-100">
Â  <div class="main-container" id="main-container">
Â  Â  Â  Â  <div class="screen" id="table-selection-screen">
Â  Â  Â  <h2 class="text-5xl font-bold text-gray-800">T-NGON</h2>
Â  Â  Â  <p class="text-lg text-gray-600 mt-2">Vui lÃ²ng chá»n bÃ n cá»§a báº¡n</p>
Â  Â  Â  <div class="button-grid" id="table-buttons"></div>
Â  Â  </div>
Â  Â  Â  Â  <div class="screen" id="start-screen">
Â  Â  Â  <div class="space-y-4 text-gray-800 text-center">
Â  Â  Â  Â  <h2 class="text-5xl font-bold">T-NGON</h2>
Â  Â  Â  Â  <p class="text-lg">Nháº¥n nÃºt bÃªn dÆ°á»›i Ä‘á»ƒ báº¯t Ä‘áº§u Ä‘áº·t mÃ³n</p>
Â  Â  Â  Â  <div class="button-container">
Â  Â  Â  Â  Â  <button class="start-button" onclick="startOrder()">ğŸ½ï¸ Báº®T Äáº¦U</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <p id="table-info" class="text-sm text-gray-500 mt-4"></p>
Â  Â  Â  Â  <div id="global-status"></div>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  Â  Â  <div class="screen" id="start-slideshow-screen">
Â  Â  Â  <div class="tap-overlay" onclick="showScreen('start-screen')" title="Quay láº¡i mÃ n Báº®T Äáº¦U"></div>
Â  Â  Â  <div class="slide-stage" id="slide-stage"></div>
Â  Â  Â  <div id="slide-status" class="slide-status"></div>
Â  Â  </div>
Â  Â  Â  Â  <div class="screen" id="iframe-screen">
Â  Â  Â  <button class="return-button" onclick="clearPage()"></button>
Â  Â  </div>
Â  </div>
Â  <script>
Â  Â  /* ----------------- Config chung ----------------- */
Â  Â  const LINKS_JSON_URL = "https://tngon462.github.io/QR/links.json";
Â  Â  let selectedBan = null;
Â  Â  /* ----------------- Firebase ----------------- */
Â  Â  const firebaseConfig = {
Â  Â  Â  apiKey: "AIzaSyB4u2G41xdGkgBC0KltleRpcg5Lwru2RIU",
Â  Â  Â  authDomain: "tngon-b37d6.firebaseapp.com",
Â  Â  Â  databaseURL: "https://tngon-b37d6-default-rtdb.asia-southeast1.firebasedatabase.app",
Â  Â  Â  projectId: "tngon-b37d6",
Â  Â  Â  storageBucket: "tngon-b37d6.firebasestorage.app",
Â  Â  Â  messagingSenderId: "580319242104",
Â  Â  Â  appId: "1:580319242104:web:6922e4327bdc8286c30a8d",
Â  Â  Â  measurementId: "G-LHEH8ZC6SL"
Â  Â  };
Â  Â  let fbApp = null, rtdb = null, currentRef = null, currentBanListening = null, lastTs = 0;
Â  Â  let pollInitTs = null; // má»‘c poll Ä‘áº§u Ä‘á»ƒ bá» qua tráº¡ng thÃ¡i cÅ©
Â  Â  // Äá»“ng há»“ server Ä‘á»ƒ Ä‘á»“ng bá»™ táº¥t cáº£ mÃ¡y
Â  Â  let serverOffsetMs = 0;
Â  Â  function nowServerMs(){ return Date.now() + (Number(serverOffsetMs) || 0); }
Â  Â  function connectFirebase() {
Â  Â  Â  if (!fbApp) fbApp = firebase.initializeApp(firebaseConfig);
Â  Â  Â  if (!rtdb) rtdb = firebase.database();
Â  Â  Â  // Láº¥y chÃªnh lá»‡ch giá» server
Â  Â  Â  rtdb.ref(".info/serverTimeOffset").on("value", snap => {
Â  Â  Â  Â  serverOffsetMs = Number(snap.val() || 0);
Â  Â  Â  });
Â  Â  }
Â  Â  // Bá» QUA SNAPSHOT Äáº¦U: trÃ¡nh bá»‹ Ä‘Ã¡ vá» CTA do tráº¡ng thÃ¡i cÅ©
Â  Â  function attachListenerFor(ban) {
Â  Â  Â  if (!rtdb || currentBanListening === ban) return;
Â  Â  Â  if (currentRef) currentRef.off();
Â  Â  Â  currentBanListening = ban;
Â  Â  Â  currentRef = rtdb.ref("signals/" + ban);
Â  Â  Â  let initialized = false;
Â  Â  Â  let firstTs = 0;
Â  Â  Â  currentRef.on("value", (snap) => {
Â  Â  Â  Â  const v = snap.val();
Â  Â  Â  Â  if (!v) return;
Â  Â  Â  Â  const ts = v.ts || 0;
Â  Â  Â  Â  if (!initialized) {
Â  Â  Â  Â  Â  initialized = true;
Â  Â  Â  Â  Â  firstTs = ts;
Â  Â  Â  Â  Â  if (ts > lastTs) lastTs = ts; // Ä‘á»“ng bá»™ má»‘c hiá»‡n táº¡i
Â  Â  Â  Â  Â  return; // bá» qua snapshot Ä‘áº§u
Â  Â  Â  Â  }
Â  Â  Â  Â  if (v.status === "expired" && ts > lastTs && ts > firstTs) {
Â  Â  Â  Â  Â  lastTs = ts;
Â  Â  Â  Â  Â  clearPage(); // quay vá» CTA
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }
Â  Â  /* Fallback REST polling (áº©n) â€” CÅ¨NG Bá» QUA Láº¦N Äáº¦U */
Â  Â  async function pollExpiredFallback(){
Â  Â  Â  try{
Â  Â  Â  Â  if (!selectedBan) return;
Â  Â  Â  Â  const url = firebaseConfig.databaseURL.replace(/\/$/,"") + "/signals/" + selectedBan + ".json?cb=" + Date.now();
Â  Â  Â  Â  const res = await fetch(url, { cache: "no-store" });
Â  Â  Â  Â  if (!res.ok) return;
Â  Â  Â  Â  const v = await res.json();
Â  Â  Â  Â  if (!v) return;
Â  Â  Â  Â  const ts = v.ts || 0;
Â  Â  Â  Â  if (pollInitTs === null) { // láº§n poll Ä‘áº§u: ghi má»‘c, khÃ´ng xá»­ lÃ½
Â  Â  Â  Â  Â  pollInitTs = ts;
Â  Â  Â  Â  Â  if (ts > lastTs) lastTs = ts;
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  if (v.status === "expired" && ts > lastTs && ts > pollInitTs) {
Â  Â  Â  Â  Â  lastTs = ts;
Â  Â  Â  Â  Â  clearPage();
Â  Â  Â  Â  }
Â  Â  Â  }catch(_){}
Â  Â  }
Â  Â  setInterval(pollExpiredFallback, 3000);
Â  Â  /* ----------------- UI helpers ----------------- */
Â  Â  function showScreen(id) {
Â  Â  Â  document.querySelectorAll(".screen").forEach(s => s.style.display = "none");
Â  Â  Â  const el = document.getElementById(id);
Â  Â  Â  if (el) el.style.display = "flex";
Â  Â  }
Â  Â  function showGlobalStatus(msg){
Â  Â  Â  const el = document.getElementById("global-status");
Â  Â  Â  if (!el) return;
Â  Â  Â  if (msg && String(msg).trim()) { el.textContent = msg; el.style.display = "block"; }
Â  Â  Â  else { el.textContent = ""; el.style.display = "none"; }
Â  Â  }
Â  Â  function selectTable(banNumber) {
Â  Â  Â  selectedBan = banNumber;
Â  Â  Â  pollInitTs = null; // reset má»‘c poll khi Ä‘á»•i bÃ n
Â  Â  Â  document.getElementById("table-info").textContent = `Báº¡n Ä‘ang á»Ÿ BÃ n ${selectedBan}`;
Â  Â  Â  attachListenerFor(selectedBan);
Â  Â  Â  initSlidesThenMaybeShow(); // quyáº¿t Ä‘á»‹nh slideshow/CTA theo manifest
Â  Â  }
Â  Â  function startOrder() {
Â  Â  Â  if (!selectedBan) { return; }
Â  Â  Â  // áº¨n CTA/slideshow trÆ°á»›c khi vÃ o iframe
Â  Â  Â  document.getElementById("start-screen").style.display = "none";
Â  Â  Â  const ss = document.getElementById("start-slideshow-screen");
Â  Â  Â  if (ss) ss.style.display = "none";
Â  Â  Â  const loading = document.createElement("div");
Â  Â  Â  loading.className = "loading-indicator";
Â  Â  Â  loading.textContent = "Äang táº£i trang gá»i mÃ³n...";
Â  Â  Â  document.getElementById("main-container").appendChild(loading);
Â  Â  Â  fetch(LINKS_JSON_URL)
Â  Â  Â  Â  .then(r => { if (!r.ok) throw new Error("KhÃ´ng thá»ƒ táº£i links.json"); return r.json(); })
Â  Â  Â  Â  .then(data => {
Â  Â  Â  Â  Â  const url = data[selectedBan] ?? data[String(selectedBan)];
Â  Â  Â  Â  Â  loading.remove();
Â  Â  Â  Â  Â  if (url) createIframe(url); else showScreen("start-screen");
Â  Â  Â  Â  })
Â  Â  Â  Â  .catch(_err => { loading.remove(); showScreen("start-screen"); });
Â  Â  }
Â  Â  function createIframe(url) {
Â  Â  Â  const iframeScreen = document.getElementById("iframe-screen");
Â  Â  Â  iframeScreen.innerHTML = `<button class="return-button" onclick="clearPage()"></button>`;
Â  Â  Â  const iframe = document.createElement("iframe");
Â  Â  Â  iframe.id = "pos-iframe";
Â  Â  Â  iframe.className = "iframe-container";
Â  Â  Â  iframe.src = url;
Â  Â  Â  iframeScreen.appendChild(iframe);
Â  Â  Â  showScreen("iframe-screen");
Â  Â  }
Â  Â  function clearPage() {
Â  Â  Â  const iframeScreen = document.getElementById("iframe-screen");
Â  Â  Â  if (iframeScreen) iframeScreen.innerHTML = "";
Â  Â  Â  showScreen("start-screen");
Â  Â  }
Â  Â  /* ----------------- Auto select bÃ n ----------------- */
Â  Â  function getQueryParam(name){
Â  Â  Â  try { return new URL(window.location.href).searchParams.get(name); } catch { return null; }
Â  Â  }
Â  Â  async function backfillSelectedBanFromIframe(){
Â  Â  Â  try{
Â  Â  Â  Â  if (selectedBan) return;
Â  Â  Â  Â  const iframe = document.getElementById("pos-iframe");
Â  Â  Â  Â  if (!iframe || !iframe.src) return;
Â  Â  Â  Â  const r = await fetch(LINKS_JSON_URL);
Â  Â  Â  Â  const data = await r.json();
Â  Â  Â  Â  for (const [ban, url] of Object.entries(data)) {
Â  Â  Â  Â  Â  if (iframe.src === url) {
Â  Â  Â  Â  Â  Â  selectedBan = parseInt(ban, 10);
Â  Â  Â  Â  Â  Â  attachListenerFor(selectedBan);
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  }catch(_){}
Â  Â  }
Â  Â  setInterval(backfillSelectedBanFromIframe, 1000);
Â  Â  /* ----------------- SLIDESHOW (manifest + lá»‹ch tuyá»‡t Ä‘á»‘i) ----------------- */
Â  Â  const GH_OWNERÂ  = "tngon462";
Â  Â  const GH_REPOÂ  Â = "slide";
Â  Â  const GH_BRANCH = "main";
Â  Â  const GH_FOLDER = "slides";
Â  Â  const SLIDE_DEFAULT_DURATION_SEC = 8; // má»—i slide máº·c Ä‘á»‹nh
Â  Â  let slides = [];
Â  Â  let cumEdges = [];Â  Â // cÃ¡c má»‘c biÃªn tÃ­ch lÅ©y (ms) trong 1 chu ká»³
Â  Â  let periodMs = 0;Â  Â  // tá»•ng chu ká»³
Â  Â  let currentIndex = -1;
Â  Â  let startTs = null;Â  // má»‘c lá»‹ch tuyá»‡t Ä‘á»‘i (server)
Â  Â  let renderLoopId = null; // ID cho requestAnimationFrame
Â  Â  let watchdog = null;
Â  Â  let manifestChecked = false;
Â  Â  let slidesAvailable = false;
Â  Â  function setSlideStatus(msg){
Â  Â  Â  const box = document.getElementById("slide-status");
Â  Â  Â  if (!box) return;
Â  Â  Â  if (msg && String(msg).trim()) { box.textContent = msg; box.style.display = "block"; }
Â  Â  Â  else { box.textContent = ""; box.style.display = "none"; }
Â  Â  }
Â  Â  function msFromDur(d){
Â  Â  Â  if (typeof d === "number") return Math.max(0, Math.round(d*1000));
Â  Â  Â  if (typeof d === "string" && /s$/i.test(d)) return Math.max(0, Math.round(parseFloat(d)*1000));
Â  Â  Â  return SLIDE_DEFAULT_DURATION_SEC * 1000;
Â  Â  }
Â  Â  function isVideoUrl(u){
Â  Â  Â  try { const ext = (new URL(u)).pathname.split('.').pop().toLowerCase();
Â  Â  Â  Â  return ['mp4','webm','ogg','mov','m4v'].includes(ext);
Â  Â  Â  } catch { return false; }
Â  Â  }
Â  Â  function swapStage(el){
Â  Â  Â  const stage = document.getElementById("slide-stage"); if (!stage) return;
Â  Â  Â  while (stage.firstChild) stage.removeChild(stage.firstChild);
Â  Â  Â  stage.appendChild(el);
Â  Â  }
Â  Â  function showImage(src){
Â  Â  Â  const img = document.createElement("img");
Â  Â  Â  img.decoding = "async"; img.loading = "eager";
Â  Â  Â  img.onerror = () => setSlideStatus("Lá»—i táº£i áº£nh: " + src);
Â  Â  Â  img.onload = () => setSlideStatus("");
Â  Â  Â  img.src = src;
Â  Â  Â  swapStage(img);
Â  Â  }
Â  Â  function showVideo(src, offsetMs){
Â  Â  Â  const v = document.createElement("video");
Â  Â  Â  v.src = src; v.muted = true; v.playsInline = true; v.autoplay = true; v.preload = "auto"; v.controls = false;
Â  Â  Â  v.onerror = () => setSlideStatus("Lá»—i táº£i video: " + src);
Â  Â  Â  v.addEventListener("loadedmetadata", () => {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  const offSec = Math.min((offsetMs||0)/1000, Math.max(0,(v.duration||0)-0.05));
Â  Â  Â  Â  Â  if (isFinite(offSec) && offSec > 0) v.currentTime = offSec;
Â  Â  Â  Â  } catch(_) {}
Â  Â  Â  Â  v.play().catch(()=>{});
Â  Â  Â  Â  setSlideStatus("");
Â  Â  Â  });
Â  Â  Â  swapStage(v);
Â  Â  }
Â  Â  function buildEdges(){
Â  Â  Â  cumEdges = [];
Â  Â  Â  periodMs = 0;
Â  Â  Â  for (const s of slides){
Â  Â  Â  Â  const d = msFromDur(s.duration);
Â  Â  Â  Â  periodMs += d;
Â  Â  Â  Â  cumEdges.push(periodMs); // cuá»‘i má»—i slide
Â  Â  Â  }
Â  Â  }
Â  Â  // TÃ­nh chá»‰ sá»‘ slide theo lá»‹ch tuyá»‡t Ä‘á»‘i
Â  Â  function indexAt(nowMs){
Â  Â  Â  if (!slides.length || !periodMs || startTs==null) {
Â  Â  Â  Â  const d0 = msFromDur(slides[0]?.duration || SLIDE_DEFAULT_DURATION_SEC);
Â  Â  Â  Â  return {idx:0, offset:0, remain:d0, slideDur:d0, nextEdgeMs: nowMs + d0};
Â  Â  Â  }
Â  Â  Â  const elapsed = ((nowMs - startTs) % periodMs + periodMs) % periodMs; // [0, period)
Â  Â  Â  let idx = cumEdges.findIndex(edge => elapsed < edge);
Â  Â  Â  if (idx < 0) idx = slides.length - 1;
Â  Â  Â  const slideDur = msFromDur(slides[idx].duration);
Â  Â  Â  const startOfThis = cumEdges[idx] - slideDur;
Â  Â  Â  const offset = elapsed - startOfThis;Â  Â  Â  Â // Ä‘Ã£ trÃ´i trong slide
Â  Â  Â  const nextEdgeAbs = startTs + cumEdges[idx];
Â  Â  Â  const remain = nextEdgeAbs - nowMs;
Â  Â  Â  return { idx, offset, remain, slideDur, nextEdgeMs: nextEdgeAbs };
Â  Â  }
Â  Â  // Sá»¬A LOGIC CHÃNH Táº I ÄÃ‚Y: vÃ²ng láº·p Ä‘á»“ng bá»™ tuyá»‡t Ä‘á»‘i
Â  Â  function startSlideshowLoop() {
Â  Â  Â  const loop = () => {
Â  Â  Â  Â  if (!slides.length || !periodMs || startTs == null) {
Â  Â  Â  Â  Â  renderLoopId = requestAnimationFrame(loop);
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  const now = nowServerMs();
Â  Â  Â  Â  const { idx, offset, nextEdgeMs } = indexAt(now);
Â  Â  Â  Â  // Chá»‰ render khi slide thay Ä‘á»•i
Â  Â  Â  Â  if (idx !== currentIndex) {
Â  Â  Â  Â  Â  currentIndex = idx;
Â  Â  Â  Â  Â  const it = slides[idx];
Â  Â  Â  Â  Â  if (it.type === "video") showVideo(it.src, offset);
Â  Â  Â  Â  Â  else showImage(it.src);
Â  Â  Â  Â  }
Â  Â  Â  Â  renderLoopId = requestAnimationFrame(loop);
Â  Â  Â  };
Â  Â  Â  if (renderLoopId) cancelAnimationFrame(renderLoopId);
Â  Â  Â  renderLoopId = requestAnimationFrame(loop);
Â  Â  }
Â  Â  // HÃ m khá»Ÿi Ä‘á»™ng/dá»«ng vÃ²ng láº·p chÃ­nh
Â  Â  function stopSlideshowLoop() {
Â  Â  Â  if (renderLoopId) {
Â  Â  Â  Â  cancelAnimationFrame(renderLoopId);
Â  Â  Â  Â  renderLoopId = null;
Â  Â  Â  }
Â  Â  }
Â  Â  // ===== Watchdog 500ms: kÃ©o vá» Ä‘Ãºng slide náº¿u timer bá»‹ lá»‡ch/Ä‘Ã³ng bÄƒng =====
Â  Â  function startSyncWatchdog(){
Â  Â  Â  if (watchdog) clearInterval(watchdog);
Â  Â  Â  watchdog = setInterval(() => {
Â  Â  Â  Â  if (!slides.length || !periodMs || startTs==null) return;
Â  Â  Â  Â  const { idx } = indexAt(nowServerMs());
Â  Â  Â  Â  if (idx !== currentIndex) {
Â  Â  Â  Â  Â  console.log("Watchdog triggered: Syncing slide due to time drift.");
Â  Â  Â  Â  Â  currentIndex = idx; // Cáº­p nháº­t currentIndex Ä‘á»ƒ vÃ²ng láº·p chÃ­nh render láº¡i
Â  Â  Â  Â  }
Â  Â  Â  }, 500);
Â  Â  }
Â  Â  async function loadSlidesFromManifest(){
Â  Â  Â  const base = `https://raw.githubusercontent.com/${GH_OWNER}/${GH_REPO}/${GH_BRANCH}/${GH_FOLDER}/`;
Â  Â  Â  const urlÂ  = base + "manifest.json?cb=" + Date.now();
Â  Â  Â  try{
Â  Â  Â  Â  const res = await fetch(url, { cache: "no-store" });
Â  Â  Â  Â  if (!res.ok) {
Â  Â  Â  Â  Â  setSlideStatus("KhÃ´ng táº£i Ä‘Æ°á»£c manifest.json (HTTP " + res.status + ")");
Â  Â  Â  Â  Â  showGlobalStatus("KhÃ´ng táº£i Ä‘Æ°á»£c manifest.json (HTTP " + res.status + ")");
Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  }
Â  Â  Â  Â  let arr = await res.json();
Â  Â  Â  Â  if (!Array.isArray(arr)) {
Â  Â  Â  Â  Â  setSlideStatus("manifest.json khÃ´ng Ä‘Ãºng Ä‘á»‹nh dáº¡ng (pháº£i lÃ  máº£ng).");
Â  Â  Â  Â  Â  showGlobalStatus("manifest.json khÃ´ng Ä‘Ãºng Ä‘á»‹nh dáº¡ng (pháº£i lÃ  máº£ng).");
Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  }
Â  Â  Â  Â  const allowed = /\.(jpe?g|png|gif|mp4|webm|mov|m4v)$/i;
Â  Â  Â  Â  const items = arr
Â  Â  Â  Â  Â  .map(item => {
Â  Â  Â  Â  Â  Â  if (typeof item === "string") {
Â  Â  Â  Â  Â  Â  Â  const name = item.trim();
Â  Â  Â  Â  Â  Â  Â  if (!name) return null;
Â  Â  Â  Â  Â  Â  Â  return { src: base + name, name, duration: SLIDE_DEFAULT_DURATION_SEC };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (item && typeof item === "object" && item.src) {
Â  Â  Â  Â  Â  Â  Â  const name = String(item.src).trim();
Â  Â  Â  Â  Â  Â  Â  if (!name) return null;
Â  Â  Â  Â  Â  Â  Â  const src = name.startsWith("http") ? name : (base + name);
Â  Â  Â  Â  Â  Â  Â  const duration = Number(item.duration) > 0 ? Number(item.duration) : SLIDE_DEFAULT_DURATION_SEC;
Â  Â  Â  Â  Â  Â  Â  return { src, name, duration };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  .filter(Boolean)
Â  Â  Â  Â  Â  .filter(it => allowed.test(it.name));
Â  Â  Â  Â  if (!items.length) {
Â  Â  Â  Â  Â  setSlideStatus("KhÃ´ng tÃ¬m tháº¥y áº£nh/video há»£p lá»‡ trong manifest.json.");
Â  Â  Â  Â  Â  showGlobalStatus("KhÃ´ng tÃ¬m tháº¥y áº£nh/video há»£p lá»‡ trong manifest.json.");
Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  }
Â  Â  Â  Â  slides = items.map(it => ({ type: isVideoUrl(it.src) ? "video" : "image", src: it.src, duration: it.duration }));
Â  Â  Â  Â  buildEdges();
Â  Â  Â  Â  setSlideStatus(""); showGlobalStatus("");
Â  Â  Â  Â  return true;
Â  Â  Â  } catch(err){
Â  Â  Â  Â  setSlideStatus("Lá»—i khi táº£i/Ä‘á»c manifest.json.");
Â  Â  Â  Â  showGlobalStatus("Lá»—i khi táº£i/Ä‘á»c manifest.json.");
Â  Â  Â  Â  return false;
Â  Â  Â  }
Â  Â  }
Â  Â  // Táº¡o/Ä‘á»c â€œmá»‘c lá»‹châ€ tuyá»‡t Ä‘á»‘i trÃªn server (Ä‘áº·t 1 láº§n báº±ng ServerValue.TIMESTAMP)
Â  Â  async function ensureStartTs(){
Â  Â  Â  try {
Â  Â  Â  Â  if (!rtdb) { startTs = nowServerMs(); return; }
Â  Â  Â  Â  const ref = rtdb.ref("slideshow/startTs");
Â  Â  Â  Â  // nghe má»‘c tá»« server
Â  Â  Â  Â  ref.on("value", snap => {
Â  Â  Â  Â  Â  const val = snap.val();
Â  Â  Â  Â  Â  if (typeof val === "number" && val > 0) startTs = val;
Â  Â  Â  Â  });
Â  Â  Â  Â  // Ä‘áº·t má»‘c báº±ng transaction (chá»‰ khi chÆ°a cÃ³)
Â  Â  Â  Â  await ref.transaction(curr => {
Â  Â  Â  Â  Â  if (curr === null || curr === undefined || typeof curr !== "number" || curr <= 0) {
Â  Â  Â  Â  Â  Â  return firebase.database.ServerValue.TIMESTAMP;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  return curr;
Â  Â  Â  Â  });
Â  Â  Â  Â  // Ä‘á»c láº¡i giÃ¡ trá»‹ chuáº©n tá»« server
Â  Â  Â  Â  const s = await ref.get();
Â  Â  Â  Â  const t = s.val();
Â  Â  Â  Â  if (typeof t === "number" && t > 0) startTs = t;
Â  Â  Â  Â  else startTs = nowServerMs(); // fallback
Â  Â  Â  } catch(_){
Â  Â  Â  Â  startTs = nowServerMs();
Â  Â  Â  }
Â  Â  }
Â  Â  async function initSlidesThenMaybeShow(){
Â  Â  Â  // táº£i manifest (retry nháº¹)
Â  Â  Â  let ok = false;
Â  Â  Â  if (!manifestChecked) {
Â  Â  Â  Â  ok = await loadSlidesFromManifest();
Â  Â  Â  Â  if (!ok) {
Â  Â  Â  Â  Â  await new Promise(r => setTimeout(r, 800));
Â  Â  Â  Â  Â  ok = await loadSlidesFromManifest();
Â  Â  Â  Â  }
Â  Â  Â  Â  manifestChecked = true;
Â  Â  Â  Â  slidesAvailable = ok;
Â  Â  Â  } else ok = slidesAvailable;
Â  Â  Â  if (ok) {
Â  Â  Â  Â  if (startTs == null) { // cÃ³ slide thÃ¬ má»›i cáº§n má»‘c
Â  Â  Â  Â  Â  await ensureStartTs(); // má»‘c lá»‹ch tuyá»‡t Ä‘á»‘i
Â  Â  Â  Â  Â  currentIndex = -1;
Â  Â  Â  Â  }
Â  Â  Â  Â  startSlideshowLoop();
Â  Â  Â  Â  startSyncWatchdog(); // â­ quan trá»ng: watchdog kÃ©o lá»‡ch vá» Ä‘Ãºng
Â  Â  Â  Â  showScreen("start-slideshow-screen");
Â  Â  Â  } else {
Â  Â  Â  Â  showScreen("start-screen");
Â  Â  Â  }
Â  Â  Â  resetIdleTimer(); // (re)start idle 59s
Â  Â  }
Â  Â  /* ----------------- Idle 59s â†’ tá»± báº­t slideshow ----------------- */
Â  Â  const IDLE_MS = 59000;
Â  Â  let idleTimer = null;
Â  Â  function isOnStartScreen(){
Â  Â  Â  const el = document.getElementById("start-screen");
Â  Â  Â  return el && el.style.display !== "none";
Â  Â  }
Â  Â  function resetIdleTimer(){
Â  Â  Â  if (idleTimer) { clearTimeout(idleTimer); idleTimer = null; }
Â  Â  Â  if (isOnStartScreen()) {
Â  Â  Â  Â  idleTimer = setTimeout(async () => {
Â  Â  Â  Â  Â  if (!slidesAvailable) {
Â  Â  Â  Â  Â  Â  const ok = await loadSlidesFromManifest();
Â  Â  Â  Â  Â  Â  if (ok) slidesAvailable = true;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  if (slidesAvailable) {
Â  Â  Â  Â  Â  Â  if (startTs == null) await ensureStartTs();
Â  Â  Â  Â  Â  Â  currentIndex = -1;
Â  Â  Â  Â  Â  Â  startSlideshowLoop(); // KHá»I Äá»˜NG VÃ’NG Láº¶P
Â  Â  Â  Â  Â  Â  startSyncWatchdog(); // â­ báº­t watchdog cáº£ khi auto báº­t
Â  Â  Â  Â  Â  Â  setSlideStatus(""); showGlobalStatus("");
Â  Â  Â  Â  Â  Â  showScreen("start-slideshow-screen");
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  setSlideStatus("KhÃ´ng thá»ƒ báº­t slideshow tá»± Ä‘á»™ng: khÃ´ng cÃ³ slide.");
Â  Â  Â  Â  Â  Â  showGlobalStatus("KhÃ´ng thá»ƒ báº­t slideshow tá»± Ä‘á»™ng: khÃ´ng cÃ³ slide.");
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }, IDLE_MS);
Â  Â  Â  }
Â  Â  }
Â  Â  ["touchstart","touchmove","mousedown","mousemove","keydown"].forEach(evt => {
Â  Â  Â  window.addEventListener(evt, () => { resetIdleTimer(); }, { passive:true });
Â  Â  });
Â  Â  /* ----------------- Khá»Ÿi Ä‘á»™ng ----------------- */
Â  Â  document.addEventListener("DOMContentLoaded", () => {
Â  Â  Â  connectFirebase();
Â  Â  Â  // Táº¡o nÃºt bÃ n (giá»¯ nguyÃªn style)
Â  Â  Â  const wrap = document.getElementById("table-buttons");
Â  Â  Â  for (let i = 1; i <= 15; i++) {
Â  Â  Â  Â  const btn = document.createElement("button");
Â  Â  Â  Â  btn.className = "table-button";
Â  Â  Â  Â  btn.textContent = "BÃ n " + i;
Â  Â  Â  Â  btn.addEventListener("click", () => {
Â  Â  Â  Â  Â  selectedBan = i;
Â  Â  Â  Â  Â  pollInitTs = null;
Â  Â  Â  Â  Â  document.getElementById("table-info").textContent = `Báº¡n Ä‘ang á»Ÿ BÃ n ${selectedBan}`;
Â  Â  Â  Â  Â  attachListenerFor(selectedBan);
Â  Â  Â  Â  Â  initSlidesThenMaybeShow();
Â  Â  Â  Â  });
Â  Â  Â  Â  wrap.appendChild(btn);
Â  Â  Â  }
Â  Â  Â  // Há»— trá»£ ?ban=10 â†’ auto chá»n + auto start
Â  Â  Â  const qBan = getQueryParam("ban");
Â  Â  Â  if (qBan) {
Â  Â  Â  Â  const n = parseInt(qBan, 10);
Â  Â  Â  Â  if (!isNaN(n)) setTimeout(() => {
Â  Â  Â  Â  Â  selectedBan = n;
Â  Â  Â  Â  Â  pollInitTs = null;
Â  Â  Â  Â  Â  document.getElementById("table-info").textContent = `Báº¡n Ä‘ang á»Ÿ BÃ n ${selectedBan}`;
Â  Â  Â  Â  Â  attachListenerFor(selectedBan);
Â  Â  Â  Â  Â  initSlidesThenMaybeShow();
Â  Â  Â  Â  Â  startOrder(); // hÃ nh vi gá»‘c
Â  Â  Â  Â  }, 100);
Â  Â  Â  }
Â  Â  Â  // PhÃ²ng khi máº¥t selectedBan mÃ  iframe cÃ²n
Â  Â  Â  setInterval(backfillSelectedBanFromIframe, 1000);
Â  Â  });
Â  Â  // Helper query param
Â  Â  function getQueryParam(name){
Â  Â  Â  try { return new URL(window.location.href).searchParams.get(name); } catch { return null; }
Â  Â  }
Â  </script>
</body>
</html>
